<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="(Portswigger/WebAcademy) - Web Cache Poisoning (Unkeyed Inputs)" /><meta name="author" content="eng4ge" /><meta property="og:locale" content="en" /><meta name="description" content="Intro This post/writeup is all about the Web Cache Poisoning." /><meta property="og:description" content="Intro This post/writeup is all about the Web Cache Poisoning." /><link rel="canonical" href="https://an9k0r.github.io/posts/Web_Cache_Poisoning/" /><meta property="og:url" content="https://an9k0r.github.io/posts/Web_Cache_Poisoning/" /><meta property="og:site_name" content="CyberSec-Research.Space" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-10-27T09:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="(Portswigger/WebAcademy) - Web Cache Poisoning (Unkeyed Inputs)" /><meta name="twitter:site" content="@cybersec_space" /><meta name="twitter:creator" content="@eng4ge" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"eng4ge"},"description":"Intro This post/writeup is all about the Web Cache Poisoning.","headline":"(Portswigger/WebAcademy) - Web Cache Poisoning (Unkeyed Inputs)","dateModified":"2022-11-29T11:53:14+01:00","url":"https://an9k0r.github.io/posts/Web_Cache_Poisoning/","datePublished":"2022-10-27T09:00:00+02:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://an9k0r.github.io/posts/Web_Cache_Poisoning/"},"@context":"https://schema.org"}</script><title>(Portswigger/WebAcademy) - Web Cache Poisoning (Unkeyed Inputs) | CyberSec-Research.Space</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="CyberSec-Research.Space"><meta name="application-name" content="CyberSec-Research.Space"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/images/logo.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">CyberSec-Research.Space</a></div><div class="site-subtitle font-italic">Information Security Personal Blog</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/blogging/" class="nav-link"> <i class="fa-fw fas fa-book ml-xl-3 mr-xl-3 unloaded"></i> <span>BLOGS AND GUIDES</span> </a><li class="nav-item"> <a href="/hack_the_box/" class="nav-link"> <i class="fa-fw fas fa-bug ml-xl-3 mr-xl-3 unloaded"></i> <span>HACK THE BOX</span> </a><li class="nav-item"> <a href="/blue_team_ctf/" class="nav-link"> <i class="fa-fw fas fa-anchor ml-xl-3 mr-xl-3 unloaded"></i> <span>BLUE TEAM CTFS</span> </a><li class="nav-item"> <a href="/web_application/" class="nav-link"> <i class="fa-fw fas fa-terminal ml-xl-3 mr-xl-3 unloaded"></i> <span>WEB APPLICATION</span> </a><li class="nav-item"> <a href="/binary_exploitation/" class="nav-link"> <i class="fa-fw fas fa-microchip ml-xl-3 mr-xl-3 unloaded"></i> <span>BINARY EXPLOITATION</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/an9k0r" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/cybersec_space" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['',''].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>(Portswigger/WebAcademy) - Web Cache Poisoning (Unkeyed Inputs)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>(Portswigger/WebAcademy) - Web Cache Poisoning (Unkeyed Inputs)</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/an9k0r">eng4ge</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" date="2022-10-27 09:00:00 +0200" data-toggle="tooltip" data-placement="bottom" title="Thu, Oct 27, 2022, 9:00 AM +0200" >Oct 27, 2022</em> </span> <span> Updated <em class="timeago" date="2022-11-29 11:53:14 +0100 " data-toggle="tooltip" data-placement="bottom" title="Tue, Nov 29, 2022, 11:53 AM +0100" >Nov 29, 2022</em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1621 words"> <em>9 min</em> read</span></div></div></div><div class="post-content"><h1 id="intro">Intro</h1><p>This post/writeup is all about the Web Cache Poisoning.</p><p>I’ll be using primarily <a href="https://portswigger.net/web-security/web-cache-poisoning">Portswigger Web Academy</a> Labs, but i do intent do throw other labs and writeups here as well.</p><p>To learn more on the topic, please visit the article linked above at Portswigger’s. I also recommend reading <a href="https://portswigger.net/research/practical-web-cache-poisoning">Practical Web Cache Poisoning</a> Article.</p><h2 id="toc">TOC<a href="#toc" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li><a href="#intro">Intro</a><ul><li><a href="#toc">TOC</a></ul><li><a href="#web-cache-poisoning-with-an-unkeyed-header">Web cache poisoning with an unkeyed header</a><li><a href="#web-cache-poisoning-with-an-unkeyed-cookie">Web cache poisoning with an unkeyed cookie</a><li><a href="#web-cache-poisoning-with-multiple-headers">Web cache poisoning with multiple headers</a><li><a href="#targeted-web-cache-poisoning-using-an-unknown-header">Targeted web cache poisoning using an unknown header</a><li><a href="#web-cache-poisoning-to-exploit-a-dom-vulnerability-via-a-cache-with-strict-cacheability-criteria">Web cache poisoning to exploit a DOM vulnerability via a cache with strict cacheability criteria</a><li><a href="#combining-web-cache-poisoning-vulnerabilities">Combining web cache poisoning vulnerabilities</a></ul><h1 id="web-cache-poisoning-with-an-unkeyed-header">Web cache poisoning with an unkeyed header</h1><blockquote><p>This lab is vulnerable to web cache poisoning because it handles input from an unkeyed header in an unsafe way. An unsuspecting user regularly visits the site’s home page. To solve this lab, poison the cache with a response that executes <strong>alert(document.cookie)</strong> in the visitor’s browser.</p></blockquote><p>We start with the Shop page</p><p><img data-src="/assets/images/99b6d74cbc49f2f157ef80671d80a1eb2fa93999d05c1a929c8e9857c29a2013.png" alt="picture 1" data-proofer-ignore></p><p>Let’s check the request(s) in Burp.</p><p>We can already tell that we’re caching is active on the webserver (<code class="language-plaintext highlighter-rouge">X-Cache</code> header is present along with <code class="language-plaintext highlighter-rouge">Age</code> and <code class="language-plaintext highlighter-rouge">Cache-Control'</code>)</p><p><img data-src="/assets/images/d4f64a140cf773bb3acd26fc14e7c931cfeb7e9bbbfab3380d351bb931b6f4d6.png" alt="picture 2" data-proofer-ignore></p><p>Can we poison the Cache?</p><p><img data-src="/assets/images/9442b0b342755a0a0a7df3e0515175fdbe9cc01ce35495ef331b23a1f99a2846.png" alt="picture 5" data-proofer-ignore></p><p>Yes we can, using <code class="language-plaintext highlighter-rouge">X-Forwarded-Host</code>. Make sure to get rid of path that get’s appended afterwards (mind the <code class="language-plaintext highlighter-rouge">#</code>).</p><p><img data-src="/assets/images/0deb18bc0fa9db743a57685dc089e81403ded4261655f5e804d82485dce1fd84.png" alt="picture 6" data-proofer-ignore></p><p>Lab has been solved. PS: You can also check the Access Logs to see if <code class="language-plaintext highlighter-rouge">Victim</code> has been connecting to exploit server or not.</p><h1 id="web-cache-poisoning-with-an-unkeyed-cookie">Web cache poisoning with an unkeyed cookie</h1><blockquote><p>This lab is vulnerable to web cache poisoning because cookies aren’t included in the cache key. An unsuspecting user regularly visits the site’s home page. To solve this lab, poison the cache with a response that executes <strong>alert(1)</strong> in the visitor’s browser.</p></blockquote><p>The page looks same as in the lab before. If we take a look at the requests we’ll see <code class="language-plaintext highlighter-rouge">fehost</code> cookie, and it’s value gets reflected to the response.</p><p><img data-src="/assets/images/83d4a7d9c7752270956e1207104d455baa5fd5861e51231439e060c442c4e73a.png" alt="picture 7" data-proofer-ignore></p><p>If we carefully check how the values gets translated into response, we can come up with something like that:</p><p><img data-src="/assets/images/7a3bb8c29e2f09e6dd039f5715e3b7e38e9874f897a89f84574d020eb61790bf.png" alt="picture 8" data-proofer-ignore></p><p>We just need to trigger <code class="language-plaintext highlighter-rouge">alert(1)</code> that has been put into cache. TTL is again 30 seconds.</p><p><img data-src="/assets/images/55477d90f589fb4ca5f6a079604311aa45466fae727cdd2f33f1526e7de45c35.png" alt="picture 9" data-proofer-ignore></p><h1 id="web-cache-poisoning-with-multiple-headers">Web cache poisoning with multiple headers</h1><blockquote><p>This lab contains a web cache poisoning vulnerability that is only exploitable when you use multiple headers to craft a malicious request. A user visits the home page roughly once a minute. To solve this lab, poison the cache with a response that executes alert(document.cookie) in the visitor’s browser.</p></blockquote><p>Page looks exacly the same as in the previous labs. This lab however needed more fiddling with the headrers and was not so straightforward as the previous labs.</p><p>Main difference here is when <code class="language-plaintext highlighter-rouge">X-Forwarded-Scheme: http</code> is used, server answers with 302</p><p><img data-src="/assets/images/43f1158967cea560a0205df71d8f295b2ad7dc1afd9ba2edd393c77175127060.png" alt="picture 10" data-proofer-ignore></p><p>If we use <code class="language-plaintext highlighter-rouge">X-Forwarded-Host</code> as well, we get <code class="language-plaintext highlighter-rouge">302</code> redirection to our exploit</p><p><img data-src="/assets/images/7a5c8c97ff8e85b3a47baa2d0c831456dfd0acd4ba5845abe6da729ce08fb8b5.png" alt="picture 12" data-proofer-ignore></p><p>Craft the payload accordingly (<code class="language-plaintext highlighter-rouge">alert(document.cookie)</code>), and also make sure to disable the path that get’s appended to <code class="language-plaintext highlighter-rouge">Location</code>.</p><p><img data-src="/assets/images/74617ca1eb2e2993b2c6212d803f9268d6b70f4040b13459e7f02d48e3ef2dea.png" alt="picture 11" data-proofer-ignore></p><p>You can use Access Logs to see if <code class="language-plaintext highlighter-rouge">Victim</code> has made a connection or not. If everything was done right, lab should be solved!</p><h1 id="targeted-web-cache-poisoning-using-an-unknown-header">Targeted web cache poisoning using an unknown header</h1><blockquote><p>This lab is vulnerable to web cache poisoning. A victim user will view any comments that you post. To solve this lab, you need to poison the cache with a response that executes alert(document.cookie) in the visitor’s browser. However, you also need to make sure that the response is served to the specific subset of users to which the intended victim belongs.</p></blockquote><p>In this lab when we load the page, we see <code class="language-plaintext highlighter-rouge">Vary</code> header in the response, which implies that caching should be <code class="language-plaintext highlighter-rouge">User Agent</code> based. At least that was my understanding when solving this particular lab.</p><p><img data-src="/assets/images/0fd114d5540a97bac87704152244b9449f078595daa2591b84e039774422c620.png" alt="picture 13" data-proofer-ignore></p><p>If we start <code class="language-plaintext highlighter-rouge">Param-miner</code> Burp extension, it should return 2 headers back to us. Origin is most like not unkeyed though in the cache.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>Loaded Param Miner v1.4d
Updating active thread pool size to 8
Queued 1 attacks
Initiating header bruteforce on 0ab600840368b45fc045a7e8004f00ee.web-security-academy.net
Identified parameter on 0ab600840368b45fc045a7e8004f00ee.web-security-academy.net: x-host
Identified parameter on 0ab600840368b45fc045a7e8004f00ee.web-security-academy.net: origin~https://%s.%h
Identified parameter on 0ab600840368b45fc045a7e8004f00ee.web-security-academy.net: origin
</pre></table></code></div></div><p>And indeed, <code class="language-plaintext highlighter-rouge">X-Host</code> does reflect itself in the response.</p><p><img data-src="/assets/images/8cbad2c72b174fe4a5a349188531aa89d388e11e85a3fac06098c4fa02dc77d0.png" alt="picture 1" data-proofer-ignore></p><p>Now we’ll need a XSS to effiecently exploit our victim as we need to know what User-Agent it is being used.</p><p>We can post a comment under any post like a simple image</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>&lt;img src="exploit-server" /&gt;
</pre></table></code></div></div><p>You should receive a callback from victim with it’s <code class="language-plaintext highlighter-rouge">User-Agent</code>.</p><p><img data-src="/assets/images/41239b66929315b2770795c46fea11fd050d7dc3d9e3f55aa05bb5693f908547.png" alt="picture 3" data-proofer-ignore></p><p>Now let’s try to poison webcache.</p><p>We need to change payload accordingly on our exploit server =&gt; <code class="language-plaintext highlighter-rouge">alert(document.cookie)</code>. When we poison the Cache, don’t forget to change the <code class="language-plaintext highlighter-rouge">User-Agent</code>.</p><p><img data-src="/assets/images/75faa5e92a0472aafb5e5874db61624af32294b85788be5c06b8fa151a4e40f1.png" alt="picture 4" data-proofer-ignore></p><h1 id="web-cache-poisoning-to-exploit-a-dom-vulnerability-via-a-cache-with-strict-cacheability-criteria">Web cache poisoning to exploit a DOM vulnerability via a cache with strict cacheability criteria</h1><blockquote><p>This lab contains a DOM-based vulnerability that can be exploited as part of a web cache poisoning attack. A user visits the home page roughly once a minute. Note that the cache used by this lab has stricter criteria for deciding which responses are cacheable, so you will need to study the cache behavior closely.</p><p>To solve the lab, poison the cache with a response that executes alert(document.cookie) in the visitor’s browser.</p></blockquote><p>Let’s browse the site first. The <code class="language-plaintext highlighter-rouge">Param Miner</code> extension returned <code class="language-plaintext highlighter-rouge">X-Forwarded-Host</code> as being reflected in response.</p><p><img data-src="/assets/images/5d28c0244f75a2b1f529c108dcfb6a3ad9e7fcc98a5d4c99301438c004db0484.png" alt="picture 6" data-proofer-ignore></p><p>It relects itself as value in JSON format, enclosed in <code class="language-plaintext highlighter-rouge">&lt;script&gt;</code>.</p><p><img data-src="/assets/images/40ca181ed884d1a2401c2f1a81f19a5279abf302f5c037ab41c32a89e8f3aa27.png" alt="picture 5" data-proofer-ignore></p><p>We need to scroll further down in the source code to find out where the <code class="language-plaintext highlighter-rouge">data.host</code> is actually being called.</p><div class="language-js highlighter-rouge"><div class="code-header"> <span label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>                   <span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span>
                        <span class="nx">initGeoLocate</span><span class="p">(</span><span class="dl">'</span><span class="s1">//</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">data</span><span class="p">.</span><span class="nx">host</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">/resources/json/geolocate.json</span><span class="dl">'</span><span class="p">);</span>
                    <span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span></pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">data.host</code> is not being sanitized in any way.</p><p>Access log shows that we’re hitting the exploit server.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>84.138.97.163   2022-11-26 12:09:08 +0000 "GET /exploit/?=/resources/json/geolocate.json HTTP/1.1" 200 "User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:107.0) Gecko/20100101 Firefox/107.0"
</pre></table></code></div></div><p>If we check the <code class="language-plaintext highlighter-rouge">initGeoLocate</code> function we will also see that our input is being put directly into <code class="language-plaintext highlighter-rouge">div</code> as value</p><p><img data-src="/assets/images/73f55c07b90cbbf52bf2638bc310d4462480695ad87a9f3940c65b71e6d00c12.png" alt="picture 1" data-proofer-ignore></p><p>We also need to bypass CORS, as if we try to load remote resource we’ll see CORS error <code class="language-plaintext highlighter-rouge">Cross-Origin Request Blocked</code>.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Access-Control-Allow-Origin: *
</pre></table></code></div></div><p>This is what i’ve used on the exploit server.</p><p><img data-src="/assets/images/14b8ba5cb50dd51ae071a84a20ed586933b3be45ecfd1acf8e6f30b5319a19eb.png" alt="picture 2" data-proofer-ignore></p><p>If everything has been done right, we should get an alert in OUR browser. I’ve poisonied more that 1 product though and the <code class="language-plaintext highlighter-rouge">/</code> in order to solve the lab!</p><p><img data-src="/assets/images/08cc27547a95f89b2b3244cadcbc2988a91af9d3f749ac9d65fba5e0e086388d.png" alt="picture 3" data-proofer-ignore></p><h1 id="combining-web-cache-poisoning-vulnerabilities">Combining web cache poisoning vulnerabilities</h1><blockquote><p>This lab is susceptible to web cache poisoning, but only if you construct a complex exploit chain.</p><p>A user visits the home page roughly once a minute and their language is set to English. To solve this lab, poison the cache with a response that executes <code class="language-plaintext highlighter-rouge">alert(document.cookie)</code> in the visitor’s browser.</p></blockquote><p>This labs needs combining two vulnerabilities togheter where we actually have to poison the cache on two places.</p><p>I’ve started <code class="language-plaintext highlighter-rouge">Param Miner</code> on <code class="language-plaintext highlighter-rouge">/</code> and <code class="language-plaintext highlighter-rouge">/?localized=1</code> (actually on other endpoits well, but the ones mentioned are relevant!)</p><ul><li><code class="language-plaintext highlighter-rouge">/</code> returned <code class="language-plaintext highlighter-rouge">X-Forwarded-Host</code> and <code class="language-plaintext highlighter-rouge">X-original-url</code><li><code class="language-plaintext highlighter-rouge">/localised=1</code> returned <code class="language-plaintext highlighter-rouge">X-original-url</code></ul><p>In order to even find the endpoints/paths i simply browsed the page.</p><p>We now know where the potential Web Cache Vulnerability might be.</p><p><img data-src="/assets/images/44e9214a96c696e8574ca5347aae4e5995de5c1f303531fbf1e951fd8727feaf.png" alt="picture 4" data-proofer-ignore></p><p>We can notice that host is being reflected being sent into following script</p><div class="language-js highlighter-rouge"><div class="code-header"> <span label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span>
  <span class="nx">initTranslations</span><span class="p">(</span><span class="dl">'</span><span class="s1">//</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">data</span><span class="p">.</span><span class="nx">host</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">/resources/json/translations.json</span><span class="dl">'</span><span class="p">);</span>
<span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span></pre></table></code></div></div><p>File <code class="language-plaintext highlighter-rouge">translations.json</code> looks like this (it was already modified by me, only the <code class="language-plaintext highlighter-rouge">español</code>)</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
</pre><td class="rouge-code"><pre>{
    "en": {
        "name": "English"
    },
    "es": {
        "name": "español",
        "translations": {
            "Return to list": "its just on the product page :(",
            "View details": "&lt;/a&gt;&lt;img src=1 onerror='alert(document.cookie)' /&gt;",
            "Description:": "Descripción:"
        }
    },
    "cn": {
        "name": "中文",
        "translations": {
            "Return to list": "返回清單",
            "View details": "查看詳情",
            "Description:": "描述:"
        }
    },
    "ar": {
        "name": "عربى",
        "translations": {
            "Return to list": "العودة إلى القائمة",
            "View details": "عرض التفاصيل",
            "Description:": "وصف:"
        }
    },
    "en-gb": {
        "name": "Proper English",
        "translations": {
            "Return to list": "From whence you came",
            "View details": "Do me the honour of elaborating",
            "Description:": "Pontifications on the subject matter:"
        }
    },
    "ml": {
        "name": "മലയാളം",
        "translations": {
            "Return to list": "ലിസ്റ്റിലേക്ക് മടങ്ങുക",
            "View details": "വിശദാംശങ്ങൾ കാണുക",
            "Description:": "വിവരണം:"
        }
    },
    "hb": {
        "name": "עברית",
        "translations": {
            "Return to list": "חזור לרשימה",
            "View details": "הצג פרטים",
            "Description:": "תיאור:"
        }
    },
    "zl": {
        "name": "Ẕ̻͕̿̊ͤ̍ͅa͙l̗ͧg̮̤̰̘͇ȍ͇͕̳̙͙͉́̅̋̌̅",
        "translations": {
            "Return to list": "Re̹̰̘͉̹̪ͅt̬̫̜ȕͩ͒ͥͥr̃̉͒n ̎͂t͎͖̽͋o͖̟͚͙̲͐ͤͫ̎̓ ̼̟͈̭͉͎̂ͯ̔ͤͤ̏͐ͅliͤ͑ͧ̆̐̈̀sṭ̠̮̰͍̙͒̔͆̈ͤ̅",
            "View details": "V̖̮͙ͅi͇e͙̦w̭̣̫͇̦̬̰ ̓͑̓ͯ̔d͍͂e͚̮͖͍͖̠͙ͮͭ̉ͦ̏͌̆t̙͎̺͉a̳̖͔̱͉̱͑̆̌̃͊ͬi̯͚͙̼̹̮l̖͎͛̈́͒ͅs̒̒ͤ̽̒̀",
            "Description:": "D̳͔e̝ͩ̐ͅsc̗̱̼̤̬̎̓ͪͣͭ̐ͅr̪̝͖̙̱̄̓͌̓̚ip̭̦̭̰̻ͣ̓̽ͨ̚ț̤̝̻i̹̱̟̞͕̓̓ͬ̓ͬ̆ͅon̠͚͕̈́̋̓:"
        }
    },
    "fn": {
        "name": "Suomalainen",
        "translations": {
            "Return to list": "Palaa luetteloon",
            "View details": "Näytä kuvaus",
            "Description:": "Kuvaus:"
        }
    },
    "hw": {
        "name": "Ōlelo Hawaiʻi",
        "translations": {
            "Return to list": "Hoʻi i ka papa inoa",
            "View details": "E nānā i nā kikoʻī",
            "Description:": "ʻO keʻano:"
        }
    },
    "mm": {
        "name": "ဗမာ",
        "translations": {
            "Return to list": "စာရင်းသို့ပြန်သွားသည်",
            "View details": "အသေးစိတ်ကြည့်ရန်",
            "Description:": "ဖော်ပြချက်:"
        }
    }
}
</pre></table></code></div></div><p>Do not forget to add <code class="language-plaintext highlighter-rouge">Access-Control-Allow-Origin: *</code> into the header.</p><p>With the payload above, if we poison <code class="language-plaintext highlighter-rouge">/</code>, we’ll trigger the payload but ONLY if we chose ES language!</p><p><img data-src="/assets/images/44e9214a96c696e8574ca5347aae4e5995de5c1f303531fbf1e951fd8727feaf.png" alt="picture 5" data-proofer-ignore></p><p>Now we should be able to trigger an Alert.</p><p>To trigger an alert at <code class="language-plaintext highlighter-rouge">victim</code>’s, We’d need to poison cache on another spot. If we set <code class="language-plaintext highlighter-rouge">x-original-url: /setlang\es</code></p><p><img data-src="/assets/images/ba77ed0921bceaa9c0e2e3f435d9a50b4072767a0b0768f7a05a5d436fa60784.png" alt="picture 6" data-proofer-ignore></p><p>The <code class="language-plaintext highlighter-rouge">/setlang\es</code> part was the one that needed some fiddling around.</p><p><img data-src="/assets/images/2ac2e7c0b26bdb3dd944309cc80aee842a8fbe46354073a2f8430fb6c8349d34.png" alt="picture 7" data-proofer-ignore></p><p><img data-src="/assets/images/510a0d3b6fccba4bff844a6bf70fd060b2957a0811e3e79c88068db41f58ee6f.png" alt="picture 8" data-proofer-ignore></p><p>If we twist the slash, webserver will autocorrect. We can confirm that <code class="language-plaintext highlighter-rouge">302</code> requests are cache-ble and autocorrection is doing us a favour.</p><p>If we’ve done everything right and poisoned the cache which will lure all users to spanish page, we should have solced the lab.</p><p><img data-src="/assets/images/62e28004d8ae8dc988739520c8b0a47420b5ea8be9bdb921d9103cadb3fdcef7.png" alt="picture 9" data-proofer-ignore></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/web-application/'>Web Application</a>, <a href='/categories/web-cache-poisoning/'>Web Cache Poisoning</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/notes/" class="post-tag no-text-decoration" >Notes</a> <a href="/tags/web-application/" class="post-tag no-text-decoration" >Web Application</a> <a href="/tags/portswigger/" class="post-tag no-text-decoration" >Portswigger</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=(Portswigger/WebAcademy) - Web Cache Poisoning (Unkeyed Inputs) - CyberSec-Research.Space&url=https://an9k0r.github.io/posts/Web_Cache_Poisoning/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=(Portswigger/WebAcademy) - Web Cache Poisoning (Unkeyed Inputs) - CyberSec-Research.Space&u=https://an9k0r.github.io/posts/Web_Cache_Poisoning/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=(Portswigger/WebAcademy) - Web Cache Poisoning (Unkeyed Inputs) - CyberSec-Research.Space&url=https://an9k0r.github.io/posts/Web_Cache_Poisoning/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/insecure_deserialization/">(Portswigger/WebAcademy) - Insecure Deserialization vulnerabilities</a><li><a href="/posts/ssti/">(Portswigger/WebAcademy) - Server-Side Template Injection vulnerabilities</a><li><a href="/posts/stored_XSS/">(Portswigger/WebAcademy) - Stored Cross-Site Scripting (XSS)</a><li><a href="/posts/Blind_SQL_Injection/">Blind SQL Injection</a><li><a href="/posts/OS_Command_Injection/">OS Command Injection</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/notes/">Notes</a> <a class="post-tag" href="/tags/portswigger/">Portswigger</a> <a class="post-tag" href="/tags/web-application/">Web Application</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/clear-text-credentials/">Clear Text Credentials</a> <a class="post-tag" href="/tags/password-reuse/">Password Reuse</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/deserialization/">Deserialization</a> <a class="post-tag" href="/tags/misconfiguration/">Misconfiguration</a> <a class="post-tag" href="/tags/password-cracking/">Password Cracking</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Blind_SQL_Injection/"><div class="card-body"> <em class="timeago small" date="2022-09-30 09:00:00 +0200" >Sep 30, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Blind SQL Injection</h3><div class="text-muted small"><p> Intro Lab at portswigger: Blind SQL Injection TOC Intro TOC Blind SQL injection with conditional responses Intro Finding the SQL Injection Database Enumeration ...</p></div></div></a></div><div class="card"> <a href="/posts/Alternative_vulnerable_authentication_mechanismus/"><div class="card-body"> <em class="timeago small" date="2022-09-30 09:00:00 +0200" >Sep 30, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Other vulnerable Authentication Mechanismus</h3><div class="text-muted small"><p> Intro This post/writeup is all about the Authentication vulnerabilities or Broken Authentication if we follow OWASP naming scheme. I’ll be using primarily Portswigger Web Academy Labs, but i do in...</p></div></div></a></div><div class="card"> <a href="/posts/Multi_Factor_Authentication/"><div class="card-body"> <em class="timeago small" date="2022-09-30 09:00:00 +0200" >Sep 30, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Multi-Factor Authentication (MFA)</h3><div class="text-muted small"><p> Intro This post/writeup is all about the Authentication vulnerabilities or Broken Authentication if we follow OWASP naming scheme. I’ll be using primarily Portswigger Web Academy Labs, but i do in...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/XXE_Injection/" class="btn btn-outline-primary" prompt="Older"><p>(Portswigger/WebAcademy) - XXE Injection</p></a> <a href="/posts/CSRF/" class="btn btn-outline-primary" prompt="Newer"><p>(Portswigger/WebAcademy) - Cross-Site Request Forgery (CSRF)</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/cybersec_space">eng4ge</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/notes/">Notes</a> <a class="post-tag" href="/tags/portswigger/">Portswigger</a> <a class="post-tag" href="/tags/web-application/">Web Application</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/clear-text-credentials/">Clear Text Credentials</a> <a class="post-tag" href="/tags/password-reuse/">Password Reuse</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/deserialization/">Deserialization</a> <a class="post-tag" href="/tags/misconfiguration/">Misconfiguration</a> <a class="post-tag" href="/tags/password-cracking/">Password Cracking</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { function updateMermaid(event) { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { const mode = event.data.message; if (typeof mermaid === "undefined") { return; } let expectedTheme = (mode === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* Re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } let initTheme = "default"; if ($("html[mode=dark]").length > 0 || ($("html[mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); window.addEventListener("message", updateMermaid); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script>
